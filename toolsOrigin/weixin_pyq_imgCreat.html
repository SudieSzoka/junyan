<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>朋友圈图片生成器 - 君言工具站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neumorphic': {
                            'light': '#f0f0f3',
                            'dark': '#d1d9e6',
                            'shadow': '#a3b1c6'
                        }
                    },
                    boxShadow: {
                        'neumorphic': '20px 20px 60px #bebebe, -20px -20px 60px #ffffff',
                        'neumorphic-inset': 'inset 20px 20px 60px #bebebe, inset -20px -20px 60px #ffffff',
                        'neumorphic-pressed': 'inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        /* 拟物风背景渐变 */
        .neumorphic-bg {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        
        /* 拟物风卡片 */
        .neumorphic-card {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .neumorphic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 25px 25px 75px #bebebe, -25px -25px 75px #ffffff;
        }
        
        /* 拟物风按钮 */
        .neumorphic-btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
            transition: all 0.2s ease;
        }
        
        .neumorphic-btn:hover {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(2px);
        }
        
        .neumorphic-btn:active {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(4px);
        }
        
        /* 拟物风输入框 */
        .neumorphic-input {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            border: none;
            transition: all 0.3s ease;
        }
        
        .neumorphic-input:focus {
            box-shadow: inset 8px 8px 16px #bebebe, inset -8px -8px 16px #ffffff;
            outline: none;
        }
        
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #d1d9e6, #a3b1c6);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #a3b1c6, #8a9bb3);
        }
        
        /* 文件上传区域 */
        .upload-area {
            border: 2px dashed #d1d9e6;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.05);
        }
        
        .upload-area.dragover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.1);
        }
        
        /* 预览区域 */
        .preview-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7d93f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="neumorphic-bg min-h-screen">
    <!-- 主内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- 功能说明 -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 bg-clip-text text-transparent mb-4">
                朋友圈图片生成器
            </h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
                生成逼真的朋友圈图片，支持文本、图片、点赞、评论等功能。可自定义配置或上传Excel批量生成。
            </p>
        </div>

        <!-- 文件上传区域 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
                <!-- Excel文件上传 -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">上传Excel文件（批量生成）</h3>
                        <a href="/res/pyq/pyq_example_optimized.xlsx" download class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors whitespace-nowrap">
                            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            下载示例Excel文件
                        </a>
                    </div>
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="uploadArea">
                            <div class="mb-2">
                                <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                            </div>
                            <p class="text-sm font-medium text-gray-700 mb-1">拖拽Excel文件到此处或点击选择</p>
                            <p class="text-xs text-gray-500 mb-2">支持.xlsx和.xls格式</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" multiple class="hidden">
                            <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                                选择文件
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 图片文件上传 -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">上传图片文件（头像、配图）</h3>
                    <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="imageUploadArea">
                        <div class="mb-2">
                            <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm font-medium text-gray-700 mb-1">拖拽图片文件到此处或点击选择</p>
                        <p class="text-xs text-gray-500 mb-2">支持jpg、png等格式，用于头像和配图</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                            选择图片
                        </button>
                    </div>
                    <div id="imagePreview" class="mt-2 grid grid-cols-3 gap-1 hidden">
                        <!-- 图片预览将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 生成按钮 -->
        <div class="text-center mb-8">
            <button id="generateBtn" onclick="generateImages()" class="neumorphic-btn px-12 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 transition-all text-lg font-medium">
                <span id="generateText">生成朋友圈图片</span>
                <span id="generateLoading" class="loading hidden ml-2"></span>
            </button>
            <button id="previewBtn" onclick="previewSingle()" class="neumorphic-btn px-8 py-4 rounded-2xl bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 transition-all text-lg font-medium ml-4">
                预览效果
            </button>
        </div>

        <!-- 错误提示 -->
        <div id="errorSection" class="hidden mb-8">
            <div class="neumorphic-card rounded-3xl p-8 border-l-4 border-red-500">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-red-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">处理失败</h3>
                        <p id="errorMessage" class="text-gray-600 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 预览区域 -->
        <div id="previewSection" class="hidden">
            <div class="neumorphic-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6">预览结果</h3>
                <div id="previewContainer" class="preview-container custom-scrollbar">
                    <!-- 预览内容将在这里显示 -->
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="downloadAll()" class="neumorphic-btn px-8 py-3 rounded-2xl bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 transition-all">
                        下载全部
                    </button>
                    <button onclick="clearAll()" class="neumorphic-btn px-8 py-3 rounded-2xl text-gray-700 hover:text-red-600 transition-all">
                        清空
                    </button>
                </div>
            </div>
        </div>

        <!-- 配置面板 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">朋友圈配置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 基础信息 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布者姓名</label>
                    <input type="text" id="publisherName" value="飞书-Ben" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="发布者姓名">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布时间</label>
                    <input type="text" id="publishTime" value="昨天" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="发布时间">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">头像文件名</label>
                    <input type="text" id="avatarFile" value="1.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="头像文件名">
                </div>
                
                <!-- 内容配置 -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布内容</label>
                    <textarea id="content" rows="4" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="输入朋友圈内容...">小小的milestone, Google给我开Adsense账号了,以后给Google打工。这个中间还有个小故事,也很好玩,分享一下。我有个有点流量的网站,想挂</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">配图文件名（逗号分隔，最多9张）</label>
                    <input type="text" id="contentImages" value="" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="1.png,2.png,3.png">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部图片文件名</label>
                    <input type="text" id="topImageFile" value="top.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="顶部图片文件名（可选）">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间字体大小</label>
                    <input type="number" id="timeFontSize" value="16" min="12" max="24" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间左边距比例</label>
                    <input type="number" id="timeLeftRatio" value="0.1" min="0" max="1" step="0.1" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间右边距比例</label>
                    <input type="number" id="timeRightRatio" value="0.1" min="0" max="1" step="0.1" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                
                <!-- 点赞配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞数量</label>
                    <input type="number" id="likeCount" value="2" min="0" max="50" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="点赞数量">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞者头像文件名（逗号分隔）</label>
                    <input type="text" id="likers" value="1.jpg,2.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="点赞者头像文件名，逗号分隔">
                </div>
                
                <!-- 评论配置 -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论（JSON格式）</label>
                    <textarea id="comments" rows="3" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder='[{"name":"飞书-Ben","content":"真aha moment, 我就需要这样的agent"},{"name":"飞书-Ben","content":"有人问起来,顺便插播一个小广告,需要买 Claude code 的话,昨天写了手把手教程,无需梯子,支持微信支付: https://larkcommunity.feishu.c..."}]'>[{"name":"飞书-Ben","content":"真aha moment, 我就需要这样的agent"},{"name":"飞书-Ben","content":"有人问起来,顺便插播一个小广告,需要买 Claude code 的话,昨天写了手把手教程,无需梯子,支持微信支付: https://larkcommunity.feishu.c..."}]</textarea>
                </div>
                
                <!-- 尺寸配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片宽度</label>
                    <input type="number" id="imageWidth" value="1080" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="375">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片高度</label>
                    <input type="number" id="imageHeight" value="2400" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="812">
                </div>
                
                <!-- 缩放系数配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">头像大小系数（图片宽度比例）</label>
                    <input type="number" id="avatarSizeRatio" value="0.107" min="0.05" max="0.2" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布者姓名字体系数</label>
                    <input type="number" id="publisherNameFontRatio" value="0.043" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">内容文字字体系数</label>
                    <input type="number" id="contentFontRatio" value="0.043" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间文字字体系数</label>
                    <input type="number" id="timeFontRatio" value="0.037" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论者姓名字体系数</label>
                    <input type="number" id="commentNameFontRatio" value="0.037" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论内容字体系数</label>
                    <input type="number" id="commentContentFontRatio" value="0.037" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞图标大小系数</label>
                    <input type="number" id="likeIconSizeRatio" value="0.043" min="0.02" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞者头像大小系数</label>
                    <input type="number" id="likerAvatarSizeRatio" value="0.053" min="0.03" max="0.1" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">配图大小系数（单张图片宽度比例）</label>
                    <input type="number" id="contentImageSizeRatio" value="0.296" min="0.2" max="0.4" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">左边距系数</label>
                    <input type="number" id="leftMarginRatio" value="0.04" min="0.02" max="0.1" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">右边距系数</label>
                    <input type="number" id="rightMarginRatio" value="0.04" min="0.02" max="0.1" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">头像与文字间距系数</label>
                    <input type="number" id="avatarTextSpacingRatio" value="0.027" min="0.01" max="0.05" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">内容行间距系数</label>
                    <input type="number" id="contentLineSpacingRatio" value="0.053" min="0.03" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片间距系数</label>
                    <input type="number" id="imageSpacingRatio" value="0.013" min="0.005" max="0.03" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞者头像间距系数</label>
                    <input type="number" id="likerSpacingRatio" value="0.013" min="0.005" max="0.03" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论行间距系数</label>
                    <input type="number" id="commentLineSpacingRatio" value="0.048" min="0.03" max="0.08" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论间距系数</label>
                    <input type="number" id="commentSpacingRatio" value="0.021" min="0.01" max="0.05" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">使用说明</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Excel文件格式要求：</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>• 第一行为标题行，必须包含：index, type, content</li>
                        <li>• 第2-8行为配置行，用于设置朋友圈参数</li>
                        <li>• 第9行开始为朋友圈记录</li>
                        <li>• 配置项包括：publisher_name, publish_time, avatar_file, content, content_images, top_image_file, time_font_size, time_left_ratio, time_right_ratio, like_count, likers, comments, 以及各种缩放系数</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">功能说明：</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>• <strong>头像</strong>：优先使用上传的图片，否则从res/pyq文件夹随机选择</li>
                        <li>• <strong>多图配图</strong>：支持最多9张图片，每张显示为正方形（裁剪显示），宽度为可显示区域的1/3</li>
                        <li>• <strong>顶部图片</strong>：支持自定义顶部图片，可设置时间显示位置和大小</li>
                        <li>• <strong>点赞</strong>：使用本地点赞图标，显示点赞者头像，每行最多8个</li>
                        <li>• <strong>评论</strong>：支持多条评论，评论者名字后自动添加冒号，评论区有灰色背景</li>
                        <li>• <strong>缩放系数</strong>：所有尺寸都基于图片宽度比例设置，支持自定义头像大小、字体大小、间距等</li>
                        <li>• <strong>样式</strong>：完全还原微信朋友圈的真实样式</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局变量
        let uploadedFiles = [];
        let uploadedImages = [];
        let generatedImages = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupImageUpload();
        });

        // 设置文件上传
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // 拖拽上传
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // 点击上传
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFiles(files);
            });
        }

        // 设置图片上传
        function setupImageUpload() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');

            // 拖拽上传
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });

            imageUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
            });

            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // 点击上传
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleImageFiles(files);
            });
        }

        // 处理上传的文件
        function handleFiles(files) {
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (excelFiles.length === 0) {
                showError('请选择Excel文件（.xlsx或.xls格式）');
                return;
            }

            uploadedFiles = excelFiles;
            hideError();
            updateUploadStatus();
        }

        // 处理上传的图片文件
        function handleImageFiles(files) {
            const imageFiles = files.filter(file => 
                file.type.startsWith('image/')
            );

            if (imageFiles.length === 0) {
                showError('请选择图片文件');
                return;
            }

            uploadedImages = uploadedImages.concat(imageFiles);
            hideError();
            updateImageUploadStatus();
        }

        // 更新上传状态
        function updateUploadStatus() {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadedFiles.length > 0) {
                uploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">已选择 ${uploadedFiles.length} 个文件</p>
                    <div class="space-y-1">
                        ${uploadedFiles.map(file => `<p class="text-xs text-gray-500">${file.name}</p>`).join('')}
                    </div>
                    <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        重新选择
                    </button>
                `;
            }
        }

        // 更新图片上传状态
        function updateImageUploadStatus() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            
            if (uploadedImages.length > 0) {
                imageUploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">已选择 ${uploadedImages.length} 张图片</p>
                    <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        添加更多图片
                    </button>
                `;
                
                // 显示图片预览
                imagePreview.innerHTML = uploadedImages.map((file, index) => `
                    <div class="relative">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="w-full h-16 object-cover rounded-lg">
                        <button onclick="removeImage(${index})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">
                            ×
                        </button>
                    </div>
                `).join('');
                imagePreview.classList.remove('hidden');
            }
        }

        // 移除图片
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImageUploadStatus();
        }

        // 生成图片
        async function generateImages() {
            hideError();
            
            console.log('开始生成图片...');
            console.log('上传的文件数量:', uploadedFiles.length);
            console.log('上传的图片数量:', uploadedImages.length);
            
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoading = document.getElementById('generateLoading');
            
            generateBtn.disabled = true;
            generateText.textContent = '生成中...';
            generateLoading.classList.remove('hidden');

            try {
                generatedImages = [];
                
                if (uploadedFiles.length > 0) {
                    // 批量生成
                    console.log('开始批量生成，文件列表:', uploadedFiles.map(f => f.name));
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        console.log(`处理第${i+1}个文件:`, file.name);
                        generateText.textContent = `处理文件 ${i + 1}/${uploadedFiles.length}...`;
                        
                        const images = await processExcelFile(file);
                        console.log(`文件 ${file.name} 生成完成，图片数量:`, images.length);
                        generatedImages.push({
                            fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                            images: images
                        });
                    }
                } else {
                    // 单次生成
                    console.log('开始单次生成');
                    const config = getConfigFromForm();
                    console.log('表单配置:', config);
                    const image = await generatePyqImage(config);
                    generatedImages.push({
                        fileName: '朋友圈',
                        images: [image]
                    });
                }

                console.log('所有图片生成完成，总数:', generatedImages.length);
                generateText.textContent = '生成完成！';
                setTimeout(() => {
                    generateText.textContent = '生成朋友圈图片';
                }, 1000);
                
                showPreview();
            } catch (error) {
                console.error('生成图片失败:', error);
                showError('生成图片失败: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateLoading.classList.add('hidden');
            }
        }

        // 从表单获取配置
        function getConfigFromForm() {
            return {
                publisher_name: document.getElementById('publisherName').value || '飞书-Ben',
                publish_time: document.getElementById('publishTime').value || '昨天',
                avatar_file: document.getElementById('avatarFile').value || '1.jpg',
                content: document.getElementById('content').value || '',
                content_images: document.getElementById('contentImages').value.split(',').filter(name => name.trim()),
                top_image_file: document.getElementById('topImageFile').value || '',
                time_font_size: parseInt(document.getElementById('timeFontSize').value) || 16,
                time_left_ratio: parseFloat(document.getElementById('timeLeftRatio').value) || 0.1,
                time_right_ratio: parseFloat(document.getElementById('timeRightRatio').value) || 0.1,
                like_count: parseInt(document.getElementById('likeCount').value) || 0,
                likers: document.getElementById('likers').value.split(',').filter(name => name.trim()),
                comments: JSON.parse(document.getElementById('comments').value || '[]'),
                imageWidth: parseInt(document.getElementById('imageWidth').value) || 375,
                imageHeight: parseInt(document.getElementById('imageHeight').value) || 812,
                // 新增的缩放系数
                avatarSizeRatio: parseFloat(document.getElementById('avatarSizeRatio').value) || 0.107,
                publisherNameFontRatio: parseFloat(document.getElementById('publisherNameFontRatio').value) || 0.043,
                contentFontRatio: parseFloat(document.getElementById('contentFontRatio').value) || 0.043,
                timeFontRatio: parseFloat(document.getElementById('timeFontRatio').value) || 0.037,
                commentNameFontRatio: parseFloat(document.getElementById('commentNameFontRatio').value) || 0.037,
                commentContentFontRatio: parseFloat(document.getElementById('commentContentFontRatio').value) || 0.037,
                likeIconSizeRatio: parseFloat(document.getElementById('likeIconSizeRatio').value) || 0.043,
                likerAvatarSizeRatio: parseFloat(document.getElementById('likerAvatarSizeRatio').value) || 0.053,
                contentImageSizeRatio: parseFloat(document.getElementById('contentImageSizeRatio').value) || 0.296,
                leftMarginRatio: parseFloat(document.getElementById('leftMarginRatio').value) || 0.04,
                rightMarginRatio: parseFloat(document.getElementById('rightMarginRatio').value) || 0.04,
                avatarTextSpacingRatio: parseFloat(document.getElementById('avatarTextSpacingRatio').value) || 0.027,
                contentLineSpacingRatio: parseFloat(document.getElementById('contentLineSpacingRatio').value) || 0.053,
                imageSpacingRatio: parseFloat(document.getElementById('imageSpacingRatio').value) || 0.013,
                likerSpacingRatio: parseFloat(document.getElementById('likerSpacingRatio').value) || 0.013,
                commentLineSpacingRatio: parseFloat(document.getElementById('commentLineSpacingRatio').value) || 0.048,
                commentSpacingRatio: parseFloat(document.getElementById('commentSpacingRatio').value) || 0.021
            };
        }

        // 处理Excel文件
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        console.log('开始处理Excel文件:', file.name);
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        console.log('Excel工作簿信息:', {
                            SheetNames: workbook.SheetNames,
                            Sheets: Object.keys(workbook.Sheets)
                        });
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        console.log('使用工作表:', sheetName);
                        console.log('工作表范围:', worksheet['!ref']);
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        console.log('转换后的JSON数据:', jsonData);

                        // 解析Excel数据
                        const configs = parseExcelData(jsonData);
                        const images = [];
                        
                        console.log('解析完成，开始生成图片，配置数量:', configs.length);
                        
                        for (let i = 0; i < configs.length; i++) {
                            console.log(`生成第${i+1}张图片，配置:`, configs[i]);
                            const image = await generatePyqImage(configs[i]);
                            images.push(image);
                        }
                        
                        console.log('所有图片生成完成');
                        resolve(images);
                    } catch (error) {
                        console.error('处理Excel文件时出错:', error);
                        reject(error);
                    }
                };

                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // 解析Excel数据
        function parseExcelData(jsonData) {
            console.log('开始解析Excel数据:', jsonData);
            
            if (jsonData.length < 2) {
                throw new Error('Excel文件格式不正确');
            }

            const headers = jsonData[0];
            const data = jsonData.slice(1);
            
            console.log('Excel表头:', headers);
            console.log('Excel数据行数:', data.length);
            
            // 查找必要的列
            const indexCol = headers.findIndex(h => h === 'index');
            const contentCol = headers.findIndex(h => h === 'content');

            console.log('index列位置:', indexCol);
            console.log('content列位置:', contentCol);

            if (indexCol === -1 || contentCol === -1) {
                throw new Error('Excel文件缺少必要的列：index, content');
            }

            // 提取配置
            const configs = [];
            let currentConfig = {};

            console.log('开始遍历数据行...');
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const index = row[indexCol];
                const content = row[contentCol];

                console.log(`第${i+1}行 - index: "${index}", content: "${content}"`);

                // 改进条件检查，允许空内容但必须有index
                if (index !== undefined && index !== null && index !== '') {
                    if (['publisher_name', 'publish_time', 'avatar_file', 'content', 'content_images', 'top_image_file', 'time_font_size', 'time_left_ratio', 'time_right_ratio', 'like_count', 'likers', 'comments', 'imageWidth', 'imageHeight'].includes(index)) {
                        // 特殊处理comments字段，将其解析为JSON数组
                        if (index === 'comments') {
                            try {
                                currentConfig[index] = content ? JSON.parse(content) : [];
                            } catch (error) {
                                console.warn('解析comments JSON失败，使用空数组:', error);
                                currentConfig[index] = [];
                            }
                        } else if (index === 'likers' || index === 'content_images') {
                            // 特殊处理likers和content_images字段，将其解析为数组
                            try {
                                currentConfig[index] = content ? JSON.parse(content) : [];
                            } catch (error) {
                                console.warn(`解析${index} JSON失败，使用逗号分隔解析:`, error);
                                currentConfig[index] = content ? content.split(',').filter(name => name.trim()) : [];
                            }
                        } else if (index === 'like_count') {
                            // 特殊处理like_count字段，将其转换为数字
                            currentConfig[index] = content ? (parseInt(content) || 0) : 0;
                        } else if (index === 'imageWidth' || index === 'imageHeight') {
                            // 特殊处理图片尺寸字段，将其转换为数字
                            currentConfig[index] = content ? (parseInt(content) || 375) : (index === 'imageWidth' ? 375 : 812);
                        } else if (index === 'time_font_size') {
                            // 特殊处理时间字体大小字段，将其转换为数字
                            currentConfig[index] = content ? (parseInt(content) || 16) : 16;
                        } else if (index === 'time_left_ratio' || index === 'time_right_ratio') {
                            // 特殊处理时间边距比例字段，将其转换为浮点数
                            currentConfig[index] = content ? (parseFloat(content) || 0.1) : 0.1;
                        } else if (index === 'avatarSizeRatio' || index === 'publisherNameFontRatio' || index === 'contentFontRatio' || 
                                   index === 'timeFontRatio' || index === 'commentNameFontRatio' || index === 'commentContentFontRatio' ||
                                   index === 'likeIconSizeRatio' || index === 'likerAvatarSizeRatio' || index === 'contentImageSizeRatio' ||
                                   index === 'leftMarginRatio' || index === 'rightMarginRatio' || index === 'avatarTextSpacingRatio' ||
                                   index === 'contentLineSpacingRatio' || index === 'imageSpacingRatio' || index === 'likerSpacingRatio' ||
                                   index === 'commentLineSpacingRatio' || index === 'commentSpacingRatio') {
                            // 特殊处理缩放系数字段，将其转换为浮点数
                            const defaultValue = {
                                avatarSizeRatio: 0.107,
                                publisherNameFontRatio: 0.043,
                                contentFontRatio: 0.043,
                                timeFontRatio: 0.037,
                                commentNameFontRatio: 0.037,
                                commentContentFontRatio: 0.037,
                                likeIconSizeRatio: 0.043,
                                likerAvatarSizeRatio: 0.053,
                                contentImageSizeRatio: 0.296,
                                leftMarginRatio: 0.04,
                                rightMarginRatio: 0.04,
                                avatarTextSpacingRatio: 0.027,
                                contentLineSpacingRatio: 0.053,
                                imageSpacingRatio: 0.013,
                                likerSpacingRatio: 0.013,
                                commentLineSpacingRatio: 0.048,
                                commentSpacingRatio: 0.021
                            };
                            currentConfig[index] = content ? (parseFloat(content) || defaultValue[index]) : defaultValue[index];
                        } else {
                            currentConfig[index] = content || '';
                        }
                        console.log(`添加配置项: ${index} = ${content}`);
                    } else if (index === 'end') {
                        // 结束标记，保存当前配置
                        console.log('遇到结束标记，当前配置:', currentConfig);
                        // 移除空配置检查，只要有end标记就保存配置
                        configs.push({...currentConfig});
                        console.log(`保存配置 ${configs.length}:`, currentConfig);
                        currentConfig = {};
                    }
                }
            }

            // 添加最后一个配置（如果没有end标记）
            if (Object.keys(currentConfig).length > 0) {
                configs.push(currentConfig);
                console.log(`保存最后一个配置:`, currentConfig);
            }

            console.log('最终解析结果 - 配置数量:', configs.length);
            console.log('所有配置:', configs);

            if (configs.length === 0) {
                throw new Error('Excel文件中没有找到有效的配置');
            }

            return configs;
        }

        // 生成朋友圈图片
        async function generatePyqImage(config) {
            // 创建Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置画布尺寸
            canvas.width = config.imageWidth || 375;
            canvas.height = config.imageHeight || 812;

            // 绘制背景
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let currentY = 0;

            // 绘制顶部图片（如果有）
            if (config.top_image_file) {
                try {
                    const topImage = await loadImage(config.top_image_file);
                    const topImageWidth = canvas.width;
                    const topImageHeight = (topImage.height / topImage.width) * topImageWidth;
                    
                    ctx.drawImage(topImage, 0, 0, topImageWidth, topImageHeight);
                    
                    // 在顶部图片上绘制时间
                    const timeText = new Date().toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `bold ${config.time_font_size || 16}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 2;
                    
                    const timeX = canvas.width * (config.time_left_ratio || 0.1) + (canvas.width * (1 - config.time_left_ratio - config.time_right_ratio)) / 2;
                    const timeY = topImageHeight * 0.15;
                    
                    ctx.fillText(timeText, timeX, timeY);
                    ctx.shadowBlur = 0;
                    
                    currentY = topImageHeight;
                } catch (error) {
                    console.log('顶部图片加载失败，跳过');
                }
            }

            // 绘制朋友圈内容
            await drawPyqContent(ctx, config, canvas.width, canvas.height, currentY);

            // 转换为图片
            const imageData = canvas.toDataURL('image/png');
            return {
                dataUrl: imageData,
                width: canvas.width,
                height: canvas.height
            };
        }



        // 绘制朋友圈内容
        async function drawPyqContent(ctx, config, width, height, startY) {
            // 计算基于图片宽度的各种尺寸
            const avatarSize = Math.round(width * (config.avatarSizeRatio || 0.107));
            const leftMargin = Math.round(width * (config.leftMarginRatio || 0.04));
            const rightMargin = Math.round(width * (config.rightMarginRatio || 0.04));
            const avatarTextSpacing = Math.round(width * (config.avatarTextSpacingRatio || 0.027));
            const contentLineSpacing = Math.round(width * (config.contentLineSpacingRatio || 0.053));
            const imageSpacing = Math.round(width * (config.imageSpacingRatio || 0.013));
            
            let currentY = startY + Math.round(width * 0.053); // 顶部间距，使用宽度比例
            
            // 绘制发布者头像
            const avatarX = leftMargin;
            const avatarY = currentY;
            
            // 加载头像
            let avatarImage = null;
            try {
                if (config.avatar_file) {
                    avatarImage = await loadAvatarImage(config.avatar_file);
                }
            } catch (error) {
                console.log('头像加载失败，使用默认头像');
            }
            
            if (avatarImage) {
                ctx.drawImage(avatarImage, avatarX, avatarY, avatarSize, avatarSize);
            } else {
                // 绘制默认头像
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(avatarX, avatarY, avatarSize, avatarSize);
            }
            
            // 绘制发布者姓名
            const publisherNameFontSize = Math.round(width * (config.publisherNameFontRatio || 0.043));
            ctx.fillStyle = '#000000';
            ctx.font = `bold ${publisherNameFontSize}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
            ctx.textAlign = 'left';
            ctx.fillText(config.publisher_name || '飞书-Ben', avatarX + avatarSize + avatarTextSpacing, avatarY + Math.round(publisherNameFontSize * 0.8));
            
            currentY += avatarSize + Math.round(width * 0.027);
            
            // 绘制内容文本 - 与发布者名字左对齐
            if (config.content) {
                const textX = avatarX + avatarSize + avatarTextSpacing; // 与发布者名字左对齐
                const textWidth = width - textX - rightMargin; // 减去右边距
                const contentFontSize = Math.round(width * (config.contentFontRatio || 0.043));
                const lineHeight = Math.round(contentFontSize * 1.25);
                
                ctx.fillStyle = '#000000';
                ctx.font = `${contentFontSize}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                ctx.textAlign = 'left';
                
                // 改进的文本换行算法
                const words = config.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > textWidth) {
                        if (currentLine === '') {
                            // 单个字符就超宽，强制换行
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                // 绘制每一行
                for (let line of lines) {
                    ctx.fillText(line, textX, currentY);
                    currentY += lineHeight;
                }
                
                currentY += Math.round(width * 0.027);
            }
            
            // 绘制多张配图
            if (config.content_images && config.content_images.length > 0) {
                const maxImages = Math.min(config.content_images.length, 9);
                const contentImageSize = Math.round(width * (config.contentImageSizeRatio || 0.296));
                const imagesPerRow = 3;
                
                for (let i = 0; i < maxImages; i++) {
                    const row = Math.floor(i / imagesPerRow);
                    const col = i % imagesPerRow;
                    const imageX = leftMargin + col * (contentImageSize + imageSpacing);
                    const imageY = currentY + row * (contentImageSize + imageSpacing);
                    
                    try {
                        const contentImage = await loadContentImage(config.content_images[i]);
                        
                        // 计算裁剪区域，保持正方形
                        const minDimension = Math.min(contentImage.width, contentImage.height);
                        const sourceX = (contentImage.width - minDimension) / 2;
                        const sourceY = (contentImage.height - minDimension) / 2;
                        
                        ctx.drawImage(
                            contentImage,
                            sourceX, sourceY, minDimension, minDimension,
                            imageX, imageY, contentImageSize, contentImageSize
                        );
                    } catch (error) {
                        // 绘制图片占位符
                        ctx.fillStyle = '#e0e0e0';
                        ctx.fillRect(imageX, imageY, contentImageSize, contentImageSize);
                    }
                }
                
                const rows = Math.ceil(maxImages / imagesPerRow);
                currentY += rows * (contentImageSize + imageSpacing) + Math.round(width * 0.027);
            }
            
            // 绘制时间 - 放在点赞、评论区的上方
            if (config.publish_time) {
                const timeFontSize = Math.round(width * (config.timeFontRatio || 0.037));
                ctx.fillStyle = '#8e8e93';
                ctx.font = `${timeFontSize}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillText(config.publish_time, leftMargin, currentY + Math.round(timeFontSize * 0.8));
                currentY += Math.round(timeFontSize * 1.8);
            }
            
            // 绘制点赞区域
            if (config.like_count && config.like_count > 0) {
                currentY = await drawLikes(ctx, config, width, currentY);
            }
            
            // 绘制评论区域
            if (config.comments && config.comments.length > 0) {
                currentY = drawComments(ctx, config, width, currentY);
            }
        }

        // 绘制点赞区域
        async function drawLikes(ctx, config, width, startY) {
            const leftMargin = Math.round(width * (config.leftMarginRatio || 0.04));
            const likeIconSize = Math.round(width * (config.likeIconSizeRatio || 0.043));
            const likeIconX = leftMargin;
            const likeIconY = startY + Math.round(likeIconSize * 0.75); // 调整心形图标垂直位置
            
            // 绘制本地点赞图标
            try {
                const likeIcon = await loadImage('like_icon.png');
                ctx.drawImage(likeIcon, likeIconX, likeIconY - likeIconSize, likeIconSize, likeIconSize);
            } catch (error) {
                // 如果本地图标加载失败，使用emoji作为备选
                ctx.fillStyle = '#ff3b30';
                ctx.font = `${likeIconSize}px Arial`;
                ctx.textAlign = 'left';
                ctx.fillText('❤️', likeIconX, likeIconY);
            }
            
            // 绘制点赞者头像
            const likerAvatarSize = Math.round(width * (config.likerAvatarSizeRatio || 0.053));
            const maxAvatarsPerRow = 8;
            const likerSpacing = Math.round(width * (config.likerSpacingRatio || 0.013));
            let currentX = likeIconX + likeIconSize + Math.round(width * 0.027);
            let currentY = startY;
            let avatarCount = 0;
            
            for (let i = 0; i < Math.min(config.like_count, config.likers ? config.likers.length : 0); i++) {
                if (avatarCount >= maxAvatarsPerRow) {
                    currentX = likeIconX + likeIconSize + Math.round(width * 0.027);
                    currentY += likerAvatarSize + likerSpacing;
                    avatarCount = 0;
                }
                
                // 尝试加载点赞者头像
                let likerAvatar = null;
                try {
                    if (config.likers && config.likers[i]) {
                        likerAvatar = await loadAvatarImage(config.likers[i]);
                    }
                } catch (error) {
                    console.log('点赞者头像加载失败，使用默认头像');
                }
                
                if (likerAvatar) {
                    // 绘制圆形头像
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(currentX + likerAvatarSize/2, currentY + likerAvatarSize/2, likerAvatarSize/2, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.drawImage(likerAvatar, currentX, currentY, likerAvatarSize, likerAvatarSize);
                    ctx.restore();
                } else {
                    // 绘制默认圆形头像
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(currentX + likerAvatarSize/2, currentY + likerAvatarSize/2, likerAvatarSize/2, 0, 2 * Math.PI);
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fill();
                    ctx.restore();
                }
                
                currentX += likerAvatarSize + likerSpacing;
                avatarCount++;
            }
            
            return currentY + likerAvatarSize + Math.round(width * 0.04); // 增加底部间距，避免与评论重叠
        }

        // 绘制评论区域
        function drawComments(ctx, config, width, startY) {
            const leftMargin = Math.round(width * (config.leftMarginRatio || 0.04));
            const rightMargin = Math.round(width * (config.rightMarginRatio || 0.04));
            const commentNameFontSize = Math.round(width * (config.commentNameFontRatio || 0.037));
            const commentContentFontSize = Math.round(width * (config.commentContentFontRatio || 0.037));
            const commentLineSpacing = Math.round(width * (config.commentLineSpacingRatio || 0.048));
            const commentSpacing = Math.round(width * (config.commentSpacingRatio || 0.021));
            
            let currentY = startY + Math.round(width * 0.013); // 增加顶部间距，避免与点赞区域重叠
            
            // 确保comments是数组
            if (!Array.isArray(config.comments)) {
                console.warn('comments不是数组，跳过评论绘制');
                return currentY;
            }
            
            // 绘制评论区灰色背景
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(leftMargin, currentY - Math.round(width * 0.013), width - leftMargin - rightMargin, 100); // 临时高度，后面会调整
            
            for (let comment of config.comments) {
                // 确保comment是对象且有content属性
                if (!comment || typeof comment !== 'object' || !comment.content) {
                    console.warn('评论格式不正确，跳过:', comment);
                    continue;
                }
                
                // 绘制评论者姓名（加上冒号）
                ctx.fillStyle = '#007AFF';
                ctx.font = `bold ${commentNameFontSize}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                ctx.textAlign = 'left';
                ctx.fillText((comment.name || '用户') + '：', leftMargin, currentY + Math.round(commentNameFontSize * 0.8));
                
                // 计算评论者姓名的宽度，为评论内容留出空间
                const nameWidth = ctx.measureText((comment.name || '用户') + '：').width;
                const commentX = leftMargin + nameWidth + Math.round(width * 0.021); // 姓名后留间距
                const commentWidth = width - commentX - rightMargin; // 减去右边距
                const lineHeight = Math.round(commentContentFontSize * 1.3); // 调整行间距
                
                ctx.fillStyle = '#000000';
                ctx.font = `${commentContentFontSize}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                
                // 改进的文本换行算法
                const words = comment.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > commentWidth) {
                        if (currentLine === '') {
                            // 单个字符就超宽，强制换行
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                // 绘制每一行
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (i === 0) {
                        // 第一行与姓名同行
                        ctx.fillText(line, commentX, currentY + Math.round(commentContentFontSize * 0.8));
                    } else {
                        // 后续行缩进到与姓名对齐
                        ctx.fillText(line, leftMargin, currentY + Math.round(commentContentFontSize * 0.8));
                    }
                    currentY += lineHeight;
                }
                
                currentY += commentSpacing; // 评论间距
            }
            
            return currentY + Math.round(width * 0.027);
        }

        // 显示预览
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContainer = document.getElementById('previewContainer');
            
            previewContainer.innerHTML = '';

            generatedImages.forEach((fileData, fileIndex) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'mb-8 p-6 neumorphic-card rounded-2xl';
                fileDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-900 mb-4">${fileData.fileName}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${fileData.images.map((image, imageIndex) => `
                            <div class="neumorphic-card rounded-xl p-4">
                                <img src="${image.dataUrl}" alt="朋友圈图片" class="w-full h-auto rounded-lg mb-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">${image.width} × ${image.height}</span>
                                    <button onclick="downloadImage('${image.dataUrl}', '${fileData.fileName}_${imageIndex + 1}.png')" 
                                            class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                        下载
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                previewContainer.appendChild(fileDiv);
            });

            previewSection.classList.remove('hidden');
        }

        // 下载单个图片
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 下载全部图片
        function downloadAll() {
            generatedImages.forEach((fileData, fileIndex) => {
                fileData.images.forEach((image, imageIndex) => {
                    setTimeout(() => {
                        downloadImage(image.dataUrl, `${fileData.fileName}_${imageIndex + 1}.png`);
                    }, fileIndex * 100 + imageIndex * 50);
                });
            });
        }

        // 显示错误
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
            
            // 自动隐藏错误提示
            setTimeout(() => {
                errorSection.classList.add('hidden');
            }, 5000);
        }

        // 隐藏错误
        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        // 从文件加载图片
        function loadImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('图片加载失败'));
                img.src = URL.createObjectURL(file);
            });
        }

        // 从服务器加载图片
        function loadImageFromServer(imageName, type = 'pyq') {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`图片加载失败: ${imageName}`));
                img.src = `../res/${type}/${imageName}`;
            });
        }

        // 加载头像图片
        async function loadAvatarImage(imageName) {
            // 优先从上传的图片中查找
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }
            
            if (imageFile) {
                return await loadImageFromFile(imageFile);
            } else {
                // 从服务器加载，如果失败则随机选择
                try {
                    return await loadImageFromServer(imageName, 'pyq');
                } catch (error) {
                    // 随机选择头像
                    const randomIndex = Math.floor(Math.random() * 2) + 1;
                    return await loadImageFromServer(`${randomIndex}.jpg`, 'pyq');
                }
            }
        }

        // 加载配图
        async function loadContentImage(imageName) {
            // 优先从上传的图片中查找
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }
            
            if (imageFile) {
                return await loadImageFromFile(imageFile);
            } else {
                // 从服务器加载
                return await loadImageFromServer(imageName, 'pyq');
            }
        }

        // 预览单个效果
        async function previewSingle() {
            hideError();
            
            const previewBtn = document.getElementById('previewBtn');
            previewBtn.disabled = true;
            previewBtn.textContent = '预览中...';

            try {
                const config = getConfigFromForm();
                const image = await generatePyqImage(config);
                
                // 显示预览
                const previewSection = document.getElementById('previewSection');
                const previewContainer = document.getElementById('previewContainer');
                
                previewContainer.innerHTML = `
                    <div class="mb-8 p-6 neumorphic-card rounded-2xl">
                        <h4 class="text-lg font-bold text-gray-900 mb-4">预览效果</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="neumorphic-card rounded-xl p-4">
                                <img src="${image.dataUrl}" alt="朋友圈预览" class="w-full h-auto rounded-lg mb-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">${image.width} × ${image.height}</span>
                                    <button onclick="downloadImage('${image.dataUrl}', '朋友圈预览.png')" 
                                            class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                        下载
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                previewSection.classList.remove('hidden');
            } catch (error) {
                console.error('预览失败:', error);
                showError('预览失败: ' + error.message);
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = '预览效果';
            }
        }

        // 清空所有
        function clearAll() {
            uploadedFiles = [];
            uploadedImages = [];
            generatedImages = [];
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            hideError();
            updateUploadStatus();
            updateImageUploadStatus();
        }
    </script>
</body>
</html>