<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="/password-check.js"></script>
  <link rel="icon" type="image/png" href="/res/pyq/junyan.png">
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="themes/default.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天图片生成器 - 君言工具站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neumorphic': {
                            'light': '#f0f0f3',
                            'dark': '#d1d9e6',
                            'shadow': '#a3b1c6'
                        }
                    },
                    boxShadow: {
                        'neumorphic': '20px 20px 60px #bebebe, -20px -20px 60px #ffffff',
                        'neumorphic-inset': 'inset 20px 20px 60px #bebebe, inset -20px -20px 60px #ffffff',
                        'neumorphic-pressed': 'inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        /* 拟物风背景渐变 */
        .neumorphic-bg {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        
        /* 拟物风卡片 */
        .neumorphic-card {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .neumorphic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 25px 25px 75px #bebebe, -25px -25px 75px #ffffff;
        }
        
        /* 拟物风按钮 */
        .neumorphic-btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
            transition: all 0.2s ease;
        }
        
        .neumorphic-btn:hover {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(2px);
        }
        
        .neumorphic-btn:active {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(4px);
        }
        
        /* 拟物风输入框 */
        .neumorphic-input {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            border: none;
            transition: all 0.3s ease;
        }
        
        .neumorphic-input:focus {
            box-shadow: inset 8px 8px 16px #bebebe, inset -8px -8px 16px #ffffff;
            outline: none;
        }
        
        /* 拟物风头部 */
        .neumorphic-header {
            background: linear-gradient(145deg, #ffffff, #f0f0f3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #d1d9e6, #a3b1c6);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #a3b1c6, #8a9bb3);
        }
        
        /* 文件上传区域 */
        .upload-area {
            border: 2px dashed #d1d9e6;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.05);
        }
        
        .upload-area.dragover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.1);
        }
        
        /* 预览区域 */
        .preview-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* 聊天消息样式 */
        .chat-message {
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .chat-message.me {
            justify-content: flex-end;
        }
        
        .chat-message.other {
            justify-content: flex-start;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 0;
            object-fit: cover;
            margin: 0 8px;
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .chat-bubble.me {
            background: linear-gradient(135deg, #94eb6a, #7dd93f);
            color: #000;
        }
        
        .chat-bubble.other {
            background: #ffffff;
            color: #000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            object-fit: cover;
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7d93f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="neumorphic-bg min-h-screen">
  <div id="websiteContent" style="display: none;">

<!-- COMMON_HEADER -->
<!-- 固定页头 -->
<header class="neumorphic-header sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <!-- Logo -->
            <div class="flex items-center space-x-6">
                <div class="flex-shrink-0">
                    <a href="../index.html" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent hover:from-blue-700 hover:to-purple-700 transition-all">
                        君言工具站
                    </a>
                </div>
            </div>

            <!-- 导航菜单 -->
            <nav class="hidden md:block">
                <div class="flex items-center space-x-4">
                    <a href="../index.html" class="neumorphic-btn px-4 py-2 rounded-xl text-gray-700 hover:text-blue-600 transition-all font-medium">首页</a>
                </div>
            </nav>

            <!-- 移动端菜单按钮 -->
            <div class="md:hidden">
                <button class="neumorphic-btn p-3 rounded-xl text-gray-700 hover:text-blue-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</header>

<style>
/* 拟物风头部 */
.neumorphic-header {
    background: linear-gradient(145deg, #ffffff, #f0f0f3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
</style>
<!-- END_COMMON_HEADER -->
    <!-- 主内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- 功能说明 -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 bg-clip-text text-transparent mb-4">
                微信聊天图片生成器
            </h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
                上传Excel文件，自动生成微信聊天界面图片。支持文本和图片消息，可自定义头像、背景等。
            </p>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
                每张图片均有隐藏水印，请勿用于非法用途！
            </p>
        </div>



        <!-- 文件上传区域 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
                <!-- Excel文件上传 -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">上传Excel文件</h3>
                        <a href="/res/wechat/chat_example.xlsx" download class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors whitespace-nowrap">
                            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            下载示例Excel文件
                        </a>
                    </div>
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="uploadArea">
                            <div class="mb-2">
                                <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                            </div>
                            <p class="text-sm font-medium text-gray-700 mb-1">拖拽Excel文件到此处或点击选择</p>
                            <p class="text-xs text-gray-500 mb-2">支持.xlsx和.xls格式</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" multiple class="hidden">
                            <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                                选择文件
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 图片文件上传 -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">上传图片文件（可选；会优先匹配）</h3>
                    <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="imageUploadArea">
                        <div class="mb-2">
                            <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm font-medium text-gray-700 mb-1">拖拽图片文件到此处或点击选择</p>
                        <p class="text-xs text-gray-500 mb-2">支持jpg、png等格式，优先使用上传的图片</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                            选择图片
                        </button>
                    </div>
                    <div id="imagePreview" class="mt-2 grid grid-cols-3 gap-1 hidden">
                        <!-- 图片预览将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 生成按钮 -->
        <div class="text-center mb-8">
            <button id="generateBtn" onclick="generateImages()" class="neumorphic-btn px-12 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 transition-all text-lg font-medium">
                <span id="generateText">生成聊天图片</span>
                <span id="generateLoading" class="loading hidden ml-2"></span>
            </button>
        </div>

        <!-- 错误提示 -->
        <div id="errorSection" class="hidden mb-8">
            <div class="neumorphic-card rounded-3xl p-8 border-l-4 border-red-500">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-red-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">处理失败</h3>
                        <p id="errorMessage" class="text-gray-600 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 预览区域 -->
        <div id="previewSection" class="hidden">
            <div class="neumorphic-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6">预览结果</h3>
                <div id="previewContainer" class="preview-container custom-scrollbar">
                    <!-- 预览内容将在这里显示 -->
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="downloadAll()" class="neumorphic-btn px-8 py-3 rounded-2xl bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 transition-all">
                        下载全部
                    </button>
                    <button onclick="clearAll()" class="neumorphic-btn px-8 py-3 rounded-2xl text-gray-700 hover:text-red-600 transition-all">
                        清空
                    </button>
                </div>
            </div>
        </div>

        <!-- 配置面板 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">生成配置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">背景尺寸</label>
                    <div class="flex space-x-2">
                        <input type="number" id="bgWidth" value="906" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="宽度">
                        <input type="number" id="bgHeight" value="1958" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="高度">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">头像大小比例</label>
                    <input type="number" id="headSize" value="0.1" step="0.01" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">文本字体大小</label>
                    <input type="number" id="fontSize" value="0.5" step="0.01" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">最大文本宽度比例</label>
                    <input type="number" id="maxTextWidth" value="0.675" step="0.01" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.65">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">最大图片宽度比例</label>
                    <input type="number" id="maxImageWidth" value="0.6" step="0.01" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.6">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">最大图片高度比例</label>
                    <input type="number" id="maxImageHeight" value="0.6" step="0.01" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.6">
                </div>
                
                <!-- 新增配置项 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">左侧头像距左侧距离比例</label>
                    <input type="number" id="headLeftSpace" value="0.04" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.02">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">右侧头像距右侧距离比例</label>
                    <input type="number" id="headRightSpace" value="0.04" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.02">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">聊天内容距左侧头像距离比例</label>
                    <input type="number" id="contentLeftSpace" value="0.02" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.02">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">聊天内容距右侧头像距离比例</label>
                    <input type="number" id="contentRightSpace" value="0.02" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.02">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部字体大小比例</label>
                    <input type="number" id="fontTopSize" value="0.1" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.03">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部时间文字大小比例</label>
                    <input type="number" id="timeFontSize" value="0.2" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.08">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间位置X坐标比例</label>
                    <input type="number" id="positionTimeX" value="0.07" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.07">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间位置Y坐标比例</label>
                    <input type="number" id="positionTimeY" value="0.4" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">名称位置比例</label>
                    <input type="number" id="positionName" value="0.85" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.6">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部背景图片</label>
                    <input type="text" id="bgTop" value="top.png" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="top.png">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">底部背景图片</label>
                    <input type="text" id="bgBottom" value="bottom.png" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="bottom.png">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部字体</label>
                    <input type="text" id="fontTop" value="simsun.ttc" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="simsun.ttc">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">聊天字体</label>
                    <input type="text" id="fontChat" value="simsun.ttc" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="simsun.ttc">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">聊天块最小间距比例</label>
                    <input type="number" id="messageSpacing" value="0.01" step="0.001" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="0.02">
                    <p class="text-xs text-gray-500 mt-1">相对于背景高度的比例，用于防止聊天内容重叠。如果仍有重叠，请增大此值</p>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">使用说明</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Excel文件格式要求：</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>• 第一行为标题行，必须包含：index, type, content</li>
                        <li>• 第2-7行为配置行，用于设置聊天界面参数</li>
                        <li>• 第8行开始为聊天记录，用户列填写"我"或"对方"</li>
                        <li>• 类型列：1=文本消息，2=图片消息</li>
                        <li>• 内容列：文本消息填写文字，图片消息填写图片文件名</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">配置参数说明：</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>• <strong>time</strong>：聊天界面左上角显示的时间（直接显示配置文本）</li>
                        <li>• <strong>name</strong>：聊天界面上方显示的名字</li>
                        <li>• <strong>chat_bg</strong>：聊天背景图片文件名</li>
                        <li>• <strong>head_me</strong>：我的头像文件名</li>
                        <li>• <strong>head_other</strong>：对方头像文件名</li>
                        <li>• <strong>output_type</strong>：输出类型（图片/视频）</li>
                        <li>• <strong>聊天块最小间距比例</strong>：防止聊天内容重叠的关键参数，建议值0.02-0.05</li>
                    </ul>
                </div>
            </div>
            <!-- <div class="mt-6 text-center">
                <a href="chat_example.xlsx" download class="neumorphic-btn px-6 py-3 rounded-xl text-blue-600 hover:text-blue-700 transition-colors">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    下载示例Excel文件
                </a>
            </div> -->
        </div>
    </main>

    <script>
        // 全局变量
        let uploadedFiles = [];
        let uploadedImages = [];
        let generatedImages = [];
        let config = {
            bgSize: [906, 1568],
            headSize: 0.1,
            fontSize: 0.5,
            maxTextWidth: 0.65,
            maxImageWidth: 0.6,
            maxImageHeight: 0.6
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupImageUpload();
            setupConfigListeners();
        });

        // 设置文件上传
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // 拖拽上传
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // 点击上传
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFiles(files);
            });
        }

        // 设置图片上传
        function setupImageUpload() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');

            // 拖拽上传
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });

            imageUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
            });

            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // 点击上传
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleImageFiles(files);
            });
        }

        // 处理上传的文件
        function handleFiles(files) {
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (excelFiles.length === 0) {
                showError('请选择Excel文件（.xlsx或.xls格式）');
                return;
            }

            uploadedFiles = excelFiles;
            hideError();
            updateUploadStatus();
        }

        // 处理上传的图片文件
        function handleImageFiles(files) {
            const imageFiles = files.filter(file => 
                file.type.startsWith('image/')
            );

            if (imageFiles.length === 0) {
                showError('请选择图片文件');
                return;
            }

            uploadedImages = uploadedImages.concat(imageFiles);
            hideError();
            updateImageUploadStatus();
        }

        // 更新上传状态
        function updateUploadStatus() {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadedFiles.length > 0) {
                uploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">已选择 ${uploadedFiles.length} 个文件</p>
                    <div class="space-y-1">
                        ${uploadedFiles.map(file => `<p class="text-xs text-gray-500">${file.name}</p>`).join('')}
                    </div>
                    <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        重新选择
                    </button>
                `;
            }
        }

        // 更新图片上传状态
        function updateImageUploadStatus() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            
            if (uploadedImages.length > 0) {
                imageUploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">已选择 ${uploadedImages.length} 张图片</p>
                    <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        添加更多图片
                    </button>
                `;
                
                // 显示图片预览
                imagePreview.innerHTML = uploadedImages.map((file, index) => `
                    <div class="relative">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="w-full h-16 object-cover rounded-lg">
                        <button onclick="removeImage(${index})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">
                            ×
                        </button>
                    </div>
                `).join('');
                imagePreview.classList.remove('hidden');
            }
        }

        // 移除图片
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImageUploadStatus();
        }

        // 设置配置监听器
        function setupConfigListeners() {
            document.getElementById('bgWidth').addEventListener('change', updateConfig);
            document.getElementById('bgHeight').addEventListener('change', updateConfig);
            document.getElementById('headSize').addEventListener('change', updateConfig);
            document.getElementById('fontSize').addEventListener('change', updateConfig);
            document.getElementById('maxTextWidth').addEventListener('change', updateConfig);
            document.getElementById('maxImageWidth').addEventListener('change', updateConfig);
            document.getElementById('maxImageHeight').addEventListener('change', updateConfig);
            
            // 新增配置项的事件监听器
            document.getElementById('headLeftSpace').addEventListener('change', updateConfig);
            document.getElementById('headRightSpace').addEventListener('change', updateConfig);
            document.getElementById('contentLeftSpace').addEventListener('change', updateConfig);
            document.getElementById('contentRightSpace').addEventListener('change', updateConfig);
            document.getElementById('fontTopSize').addEventListener('change', updateConfig);
            document.getElementById('timeFontSize').addEventListener('change', updateConfig);
            document.getElementById('positionTimeX').addEventListener('change', updateConfig);
            document.getElementById('positionTimeY').addEventListener('change', updateConfig);
            document.getElementById('positionName').addEventListener('change', updateConfig);
            document.getElementById('bgTop').addEventListener('change', updateConfig);
            document.getElementById('bgBottom').addEventListener('change', updateConfig);
            document.getElementById('fontTop').addEventListener('change', updateConfig);
            document.getElementById('fontChat').addEventListener('change', updateConfig);
            document.getElementById('messageSpacing').addEventListener('change', updateConfig);
        }

        // 更新配置
        function updateConfig() {
            config.bgSize = [
                parseInt(document.getElementById('bgWidth').value) || 906,
                parseInt(document.getElementById('bgHeight').value) || 1568
            ];
            config.headSize = parseFloat(document.getElementById('headSize').value) || 0.1;
            config.fontSize = parseFloat(document.getElementById('fontSize').value) || 0.5;
            config.maxTextWidth = parseFloat(document.getElementById('maxTextWidth').value) || 0.65;
            config.maxImageWidth = parseFloat(document.getElementById('maxImageWidth').value) || 0.6;
            config.maxImageHeight = parseFloat(document.getElementById('maxImageHeight').value) || 0.6;
            
            // 补充缺少的配置参数
            config.headLeftSpace = parseFloat(document.getElementById('headLeftSpace').value) || 0.02;
            config.headRightSpace = parseFloat(document.getElementById('headRightSpace').value) || 0.02;
            config.contentLeftSpace = parseFloat(document.getElementById('contentLeftSpace').value) || 0.02;
            config.contentRightSpace = parseFloat(document.getElementById('contentRightSpace').value) || 0.02;
            config.fontTopSize = parseFloat(document.getElementById('fontTopSize').value) || 0.03;
            config.timeFontSize = parseFloat(document.getElementById('timeFontSize').value) || 0.08;
            config.positionTime = [
                parseFloat(document.getElementById('positionTimeX').value) || 0.07,
                parseFloat(document.getElementById('positionTimeY').value) || 0.2
            ];
            config.positionName = parseFloat(document.getElementById('positionName').value) || 0.6;
            config.bgTop = document.getElementById('bgTop').value || 'top.png';
            config.bgBottom = document.getElementById('bgBottom').value || 'bottom.png';
            config.fontTop = document.getElementById('fontTop').value || 'simsun.ttc';
            config.fontChat = document.getElementById('fontChat').value || 'simsun.ttc';
            config.messageSpacing = parseFloat(document.getElementById('messageSpacing').value) || 0.02;
        }

        // 生成图片
        async function generateImages() {
            if (uploadedFiles.length === 0) {
                showError('请先上传Excel文件');
                return;
            }

            hideError();
            updateConfig();
            
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoading = document.getElementById('generateLoading');
            
            generateBtn.disabled = true;
            generateText.textContent = '生成中...';
            generateLoading.classList.remove('hidden');

            try {
                generatedImages = [];
                
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    generateText.textContent = `处理文件 ${i + 1}/${uploadedFiles.length}...`;
                    
                    const images = await processExcelFile(file);
                    generatedImages.push({
                        fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                        images: images
                    });
                }

                generateText.textContent = '生成完成！';
                setTimeout(() => {
                    generateText.textContent = '生成聊天图片';
                }, 1000);
                
                showPreview();
            } catch (error) {
                console.error('生成图片失败:', error);
                showError('生成图片失败: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateLoading.classList.add('hidden');
            }
        }

        // 处理Excel文件
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // 解析Excel数据
                        const chatData = parseExcelData(jsonData);
                        const images = generateChatImages(chatData);
                        resolve(images);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // 解析Excel数据
        function parseExcelData(jsonData) {
            if (jsonData.length < 2) {
                throw new Error('Excel文件格式不正确');
            }

            const headers = jsonData[0];
            const data = jsonData.slice(1);
            
            // 查找必要的列
            const indexCol = headers.findIndex(h => h === 'index');
            const typeCol = headers.findIndex(h => h === 'type');
            const contentCol = headers.findIndex(h => h === 'content');

            if (indexCol === -1 || typeCol === -1 || contentCol === -1) {
                throw new Error('Excel文件缺少必要的列：index, type, content');
            }

            // 提取配置和聊天记录
            const config = {};
            const messages = [];

            for (let row of data) {
                const index = row[indexCol];
                const type = row[typeCol];
                const content = row[contentCol];

                if (index && content !== undefined) {
                    if (['time', 'name', 'chat_bg', 'head_me', 'head_other', 'output_type'].includes(index)) {
                        config[index] = content;
                    } else if (['我', '对方'].includes(index)) {
                        if (type && content) {
                            messages.push({
                                user: index,
                                type: parseInt(type) || 1,
                                content: content
                            });
                        }
                    }
                }
            }

            // 验证数据
            if (messages.length === 0) {
                throw new Error('Excel文件中没有找到有效的聊天记录');
            }

            return { config, messages };
        }

        // 生成聊天图片
        async function generateChatImages(chatData) {
            const { config, messages } = chatData;
            const images = [];

            // 合并Excel配置和页面配置，参考Python代码的配置参数
            const mergedConfig = {
                // 页面配置
                bgSize: [
                    parseInt(document.getElementById('bgWidth').value) || 906,
                    parseInt(document.getElementById('bgHeight').value) || 1568
                ],
                headSize: parseFloat(document.getElementById('headSize').value) || 0.1,
                fontSize: parseFloat(document.getElementById('fontSize').value) || 0.5,
                // 使用页面配置的参数
                headLeftSpace: parseFloat(document.getElementById('headLeftSpace').value) || 0.02,
                headRightSpace: parseFloat(document.getElementById('headRightSpace').value) || 0.02,
                contentLeftSpace: parseFloat(document.getElementById('contentLeftSpace').value) || 0.02,
                contentRightSpace: parseFloat(document.getElementById('contentRightSpace').value) || 0.02,
                maxLenMsg: parseFloat(document.getElementById('maxTextWidth').value) || 0.65,
                maxLenImg: parseFloat(document.getElementById('maxImageWidth').value) || 0.6,
                maxHeightImg: parseFloat(document.getElementById('maxImageHeight').value) || 0.6,
                fontTopSize: parseFloat(document.getElementById('fontTopSize').value) || 0.03,
                timeFontSize: parseFloat(document.getElementById('timeFontSize').value) || 0.08,
                positionTime: [
                    parseFloat(document.getElementById('positionTimeX').value) || 0.07,
                    parseFloat(document.getElementById('positionTimeY').value) || 0.2
                ],
                positionName: parseFloat(document.getElementById('positionName').value) || 0.6,
                bgTop: document.getElementById('bgTop').value || 'top.png',
                bgBottom: document.getElementById('bgBottom').value || 'bottom.png',
                fontTop: document.getElementById('fontTop').value || 'simsun.ttc',
                fontChat: document.getElementById('fontChat').value || 'simsun.ttc',
                messageSpacing: parseFloat(document.getElementById('messageSpacing').value) || 0.02,
                // Excel配置
                ...config
            };

            // 创建Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置画布尺寸
            canvas.width = mergedConfig.bgSize[0];
            canvas.height = mergedConfig.bgSize[1];

            // 加载背景图片
            let bgImage = null;
            try {
                const bgName = mergedConfig.chat_bg || 'default.png';
                bgImage = await loadBgImage(bgName);
            } catch (error) {
                console.log('背景图片加载失败，使用默认背景:', error);
            }

            // 绘制背景
            if (bgImage) {
                // 绘制背景图片
                ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
            } else {
                // 使用默认背景色
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // 加载顶部和底部装饰
            let topImage = null;
            let bottomImage = null;
            try {
                topImage = await loadImageFromServer(mergedConfig.bgTop, 'chattop');
            } catch (error) {
                console.log('顶部装饰加载失败:', error);
            }
            try {
                bottomImage = await loadImageFromServer(mergedConfig.bgBottom, 'chatbottom');
            } catch (error) {
                console.log('底部装饰加载失败:', error);
            }

            // 绘制顶部装饰
            let topHeight = 0;
            if (topImage) {
                const topAspectRatio = topImage.width / topImage.height;
                topHeight = canvas.width / topAspectRatio;
                ctx.drawImage(topImage, 0, 0, canvas.width, topHeight);
            }

            // 绘制顶部信息（在顶部装饰上）
            drawTopInfo(ctx, mergedConfig, canvas.width, topHeight);

            // 绘制聊天消息
            let currentY = topHeight + 20; // 顶部装饰后的留白
            const headSize = Math.min(canvas.width, canvas.height) * mergedConfig.headSize;
            const fontSize = headSize * mergedConfig.fontSize;
            const minSpacing = canvas.height * mergedConfig.messageSpacing; // 最小间距

            for (let message of messages) {
                // 检查是否超出画布范围
                if (currentY > canvas.height - 100) {
                    console.log('消息超出画布范围，停止绘制');
                    break;
                }
                
                const messageHeight = await drawMessage(ctx, message, currentY, headSize, fontSize, canvas.width, mergedConfig);
                // 使用配置的最小间距，确保消息之间有足够的空间
                // 根据消息高度动态调整间距，长消息需要更多间距
                // 同时考虑头像大小，确保间距合理
                const dynamicSpacing = Math.max(minSpacing, Math.max(messageHeight * 0.1, headSize * 0.2));
                currentY += messageHeight + dynamicSpacing;
            }

            // 绘制底部装饰
            let bottomHeight = 0;
            if (bottomImage) {
                const bottomAspectRatio = bottomImage.width / bottomImage.height;
                bottomHeight = canvas.width / bottomAspectRatio;
                ctx.drawImage(bottomImage, 0, canvas.height - bottomHeight, canvas.width, bottomHeight);
            }

            // 转换为图片
            const imageData = canvas.toDataURL('image/png');
            images.push({
                dataUrl: imageData,
                width: canvas.width,
                height: canvas.height
            });

            return images;
        }

        // 绘制顶部信息
        function drawTopInfo(ctx, config, width, topHeight) {
            // 绘制时间 - 使用配置的位置参数
            const time = config.time || '11:30';
            ctx.fillStyle = '#666666';
            // 将比例系数转化为具体大小，确保字体足够大
            const timeFontSize = Math.max(16, Math.min(width, topHeight) * config.timeFontSize);
            ctx.font = `${timeFontSize}px "Microsoft YaHei", "SimSun", Arial, sans-serif`;
            ctx.textAlign = 'left';
            // 使用配置的时间位置
            const timeX = width * config.positionTime[0];
            const timeY = topHeight * config.positionTime[1];
            ctx.fillText(time, timeX, timeY);

            // 绘制名字
            const name = config.name || '对方';
            ctx.fillStyle = '#000000';
            // 将比例系数转化为具体大小，确保字体足够大
            const nameFontSize = Math.max(20, Math.min(width, topHeight) * config.fontTopSize * 1.5);
            ctx.font = `bold ${nameFontSize}px "Microsoft YaHei", "SimSun", Arial, sans-serif`;
            ctx.textAlign = 'center';
            // 使用配置的名称位置
            const nameY = topHeight * config.positionName;
            ctx.fillText(name, width / 2, nameY);
        }

        // 绘制消息
        async function drawMessage(ctx, message, y, headSize, fontSize, canvasWidth, config) {
            const isMe = message.user === '我';
            // 使用配置的头像位置参数
            const headX = isMe ? 
                canvasWidth - headSize - (canvasWidth * config.headRightSpace) : 
                canvasWidth * config.headLeftSpace;
            const headY = y;

            // 加载并绘制头像图片
            let headImage = null;
            try {
                if (isMe) {
                    // 尝试加载我的头像
                    const headMeName = config.head_me || '1.jpg';
                    headImage = await loadHeadImage(headMeName);
                } else {
                    // 尝试加载对方头像
                    const headOtherName = config.head_other || '2.jpg';
                    headImage = await loadHeadImage(headOtherName);
                }
            } catch (error) {
                console.log('头像加载失败，使用默认头像:', error);
            }

            if (headImage) {
                // 绘制实际头像图片（正方形）
                ctx.drawImage(headImage, headX, headY, headSize, headSize);
            } else {
                // 绘制默认头像背景（正方形）
                ctx.fillStyle = isMe ? '#94eb6a' : '#ffffff';
                ctx.fillRect(headX, headY, headSize, headSize);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 2;
                ctx.strokeRect(headX, headY, headSize, headSize);

                // 绘制头像文字
                ctx.fillStyle = '#000000';
                ctx.font = `${fontSize}px "Microsoft YaHei", "SimSun", Arial, sans-serif`;
                ctx.textAlign = 'center';
                ctx.fillText(message.user === '我' ? '我' : '他', headX + headSize/2, headY + headSize/2 + fontSize/3);
            }

            // 绘制消息内容
            if (message.type == 1) {
                return await drawTextMessage(ctx, message, headX, headY, headSize, isMe, canvasWidth, config);
            } else if (message.type == 2) {
                return await drawImageMessage(ctx, message, headX, headY, headSize, isMe, canvasWidth, config);
            }

            return headSize + 10;
        }

        // 绘制文本消息
        async function drawTextMessage(ctx, message, headX, headY, headSize, isMe, canvasWidth, config) {
            const text = message.content;
            const maxWidth = canvasWidth * config.maxLenMsg;
            const bubblePadding = 15;
            // 调整行间距，使其更合理
            const lineHeight = Math.max(20, headSize * config.fontSize * 1.2);

            // 设置字体以便测量文本
            const textFontSize = headSize * config.fontSize;
            ctx.font = `${textFontSize}px "Microsoft YaHei", "SimSun", Arial, sans-serif`;

            // 计算文本换行 - 改进的中文换行算法
            const chars = text.split('');
            const lines = [];
            let currentLine = '';

            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];
                const testLine = currentLine + char;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth - bubblePadding * 2) {
                    if (currentLine === '') {
                        // 单个字符就超宽，强制换行
                        lines.push(char);
                    } else {
                        lines.push(currentLine);
                        currentLine = char;
                    }
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }

            const bubbleHeight = lines.length * lineHeight + bubblePadding * 2;
            const bubbleWidth = Math.min(maxWidth, Math.max(...lines.map(line => ctx.measureText(line).width)) + bubblePadding * 2);

            // 计算气泡位置，参考Python代码的布局逻辑
            let bubbleX;
            if (isMe) {
                // 我的消息：头像在右边，气泡在左边
                const headRightSpace = Math.floor(canvasWidth * config.headRightSpace);
                const contentRightSpace = Math.floor(canvasWidth * config.contentRightSpace);
                bubbleX = headX - bubbleWidth - contentRightSpace - 10;
            } else {
                // 对方消息：头像在左边，气泡在右边
                const headLeftSpace = Math.floor(canvasWidth * config.headLeftSpace);
                const contentLeftSpace = Math.floor(canvasWidth * config.contentLeftSpace);
                bubbleX = headX + headSize + contentLeftSpace + 10;
            }
            
            // 计算气泡Y位置，确保气泡不会超出头像范围
            const bubbleY = Math.max(headY, headY + (headSize - bubbleHeight) / 2);

            // 绘制气泡
            ctx.fillStyle = isMe ? '#94eb6a' : '#ffffff';
            ctx.beginPath();
            ctx.roundRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight, 15);
            ctx.fill();

            // 绘制文本
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], bubbleX + bubblePadding, bubbleY + bubblePadding + (i + 1) * lineHeight);
            }

            // 尝试加载并绘制needs装饰图片，位置正对头像中间
            try {
                const needsImageName = isMe ? 'r.png' : 'l.png';
                const needsImage = await loadImageFromServer(needsImageName, 'needs');
                if (needsImage) {
                    const needsSize = 20;
                    const needsX = isMe ? bubbleX + bubbleWidth : bubbleX - needsSize;
                    const needsY = headY + headSize / 2 - needsSize / 2; // 正对头像中间
                    ctx.drawImage(needsImage, needsX, needsY, needsSize, needsSize);
                }
            } catch (error) {
                console.log('needs装饰图片加载失败:', error);
            }

            // 返回消息的实际高度，包括气泡和底部间距
            return Math.max(headSize, bubbleHeight) + 10;
        }

        // 绘制图片消息
        async function drawImageMessage(ctx, message, headX, headY, headSize, isMe, canvasWidth, config) {
            const imageName = message.content;
            const maxWidth = canvasWidth * config.maxLenImg;
            const maxHeight = canvasWidth * config.maxHeightImg;

            // 尝试从上传的图片中找到匹配的图片
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }

            // 如果没有找到上传的图片，尝试从服务器加载
            let image = null;
            if (imageFile) {
                image = await loadImageFromFile(imageFile);
            } else {
                // 尝试从服务器加载图片（chatimg目录）
                try {
                    image = await loadImageFromServer(imageName, 'chatimg');
                } catch (error) {
                    console.log('无法加载图片:', imageName);
                }
            }

            // 计算图片尺寸 - 优化：首先使用原始大小，如果超过限制则等比例缩放
            let imageWidth, imageHeight;
            
            if (image) {
                // 使用原始尺寸
                imageWidth = image.width;
                imageHeight = image.height;
                
                // 检查是否超过最大限制，如果超过则等比例缩放
                const scaleX = maxWidth / imageWidth;
                const scaleY = maxHeight / imageHeight;
                const scale = Math.min(1, scaleX, scaleY); // 不超过1，即不放大
                
                if (scale < 1) {
                    imageWidth = imageWidth * scale;
                    imageHeight = imageHeight * scale;
                }
            } else {
                // 没有图片时使用默认尺寸
                imageWidth = Math.min(maxWidth, 200);
                imageHeight = Math.min(maxHeight, 150);
            }

            // 计算图片位置，参考Python代码的布局逻辑
            let imageX;
            if (isMe) {
                // 我的图片：头像在右边，图片在左边
                const headRightSpace = Math.floor(canvasWidth * config.headRightSpace);
                const contentRightSpace = Math.floor(canvasWidth * config.contentRightSpace);
                imageX = headX - imageWidth - contentRightSpace - 10;
            } else {
                // 对方图片：头像在左边，图片在右边
                const headLeftSpace = Math.floor(canvasWidth * config.headLeftSpace);
                const contentLeftSpace = Math.floor(canvasWidth * config.contentLeftSpace);
                imageX = headX + headSize + contentLeftSpace + 10;
            }

            if (image) {
                // 绘制实际图片
                ctx.drawImage(image, imageX, headY, imageWidth, imageHeight);
            } else {
                // 绘制图片占位符
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(imageX, headY, imageWidth, imageHeight);
                
                // 绘制图片名称
                ctx.fillStyle = '#666666';
                ctx.font = '12px "Microsoft YaHei", "SimSun", Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(imageName, imageX + imageWidth/2, headY + imageHeight + 15);
            }

            // 图片类型消息不添加装饰，返回实际高度
            // 如果图片有名称显示，需要额外空间
            const extraHeight = image ? 0 : 20; // 图片占位符需要显示名称的空间
            return Math.max(headSize, imageHeight + extraHeight) + 10;
        }

        // 显示预览
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContainer = document.getElementById('previewContainer');
            
            previewContainer.innerHTML = '';

            generatedImages.forEach((fileData, fileIndex) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'mb-8 p-6 neumorphic-card rounded-2xl';
                fileDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-900 mb-4">${fileData.fileName}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${fileData.images.map((image, imageIndex) => `
                            <div class="neumorphic-card rounded-xl p-4">
                                <img src="${image.dataUrl}" alt="聊天图片" class="w-full h-auto rounded-lg mb-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">${image.width} × ${image.height}</span>
                                    <button onclick="downloadImage('${image.dataUrl}', '${fileData.fileName}_${imageIndex + 1}.png')" 
                                            class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                        下载
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                previewContainer.appendChild(fileDiv);
            });

            previewSection.classList.remove('hidden');
        }

        // 下载单个图片
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 下载全部图片
        function downloadAll() {
            generatedImages.forEach((fileData, fileIndex) => {
                fileData.images.forEach((image, imageIndex) => {
                    setTimeout(() => {
                        downloadImage(image.dataUrl, `${fileData.fileName}_${imageIndex + 1}.png`);
                    }, fileIndex * 100 + imageIndex * 50);
                });
            });
        }

        // 显示错误
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
            
            // 自动隐藏错误提示
            setTimeout(() => {
                errorSection.classList.add('hidden');
            }, 5000);
        }

        // 隐藏错误
        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        // 从文件加载图片
        function loadImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('图片加载失败'));
                img.src = URL.createObjectURL(file);
            });
        }

        // 从服务器加载图片
        function loadImageFromServer(imageName, type = 'chatimg') {
            // type: chatimg, heads, chatbgs, chattop, chatbottom, needs
            let dir = 'chatimg';
            if (type === 'heads') dir = 'heads';
            else if (type === 'chatbgs') dir = 'chatbgs';
            else if (type === 'chattop') dir = 'chattop';
            else if (type === 'chatbottom') dir = 'chatbottom';
            else if (type === 'needs') dir = 'needs';
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // 添加跨域支持
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`图片加载失败: ${imageName}`));
                img.src = `../res/wechat/${dir}/${imageName}`;
            });
        }

        // 清空所有
        function clearAll() {
            uploadedFiles = [];
            uploadedImages = [];
            generatedImages = [];
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            hideError();
            updateUploadStatus();
            updateImageUploadStatus();
        }

        // 添加Canvas的roundRect方法（如果不存在）
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }

        // 新增头像、背景加载函数
        async function loadHeadImage(imageName) {
            // 优先上传，其次服务器heads目录
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }
            if (imageFile) {
                return await loadImageFromFile(imageFile);
            } else {
                return await loadImageFromServer(imageName, 'heads');
            }
        }
        async function loadBgImage(imageName) {
            // 只从服务器chatbgs目录找
            return await loadImageFromServer(imageName, 'chatbgs');
        }
    </script>
<!-- COMMON_FOOTER -->
<!-- 固定页脚 -->
<footer class="neumorphic-footer mt-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12">
            <!-- 品牌信息 -->
            <div class="lg:col-span-2">
                <a href="../index.html" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent hover:from-blue-700 hover:to-purple-700 transition-all mb-6 inline-block">
                    君言工具站
                </a>
                <p class="text-gray-600 text-lg leading-relaxed max-w-md">
                    提供高质量、免费的在线工具，帮助您提高工作效率，解决日常问题。
                </p>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                    加入君言会员群获取密码，联系vx：trychatting
                </p>
            </div>
        </div>
    </div>
    
    <!-- 底部版权信息 -->
    <div class="neumorphic-footer-bottom">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-center">
                <p class="text-gray-600 text-sm">© 2025 君言工具站 版权所有</p>
            </div>
        </div>
    </div>
</footer>

<style>
/* 拟物风页脚 */
.neumorphic-footer {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.1);
}

.neumorphic-footer-bottom {
    background: linear-gradient(145deg, #ffffff, #f0f0f3);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}
</style>
<!-- END_COMMON_FOOTER -->

  </div>
</body>
</html> 