<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>朋友圈图片生成器 - 优化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .neumorphic-bg {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        .neumorphic-card {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .neumorphic-btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
            transition: all 0.2s ease;
        }
        .neumorphic-btn:hover {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(2px);
        }
        .neumorphic-input {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            border: none;
            transition: all 0.3s ease;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7d93f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="neumorphic-bg min-h-screen">
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 bg-clip-text text-transparent mb-4">
                朋友圈图片生成器 - 优化版
            </h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
                支持多图片、自定义顶部图片、本地点赞图标等优化功能
            </p>
        </div>

        <!-- 文件上传区域 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">上传Excel文件</h3>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">上传图片文件</h3>
                    <input type="file" id="imageInput" accept="image/*" multiple class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
            </div>
        </div>

        <!-- 生成按钮 -->
        <div class="text-center mb-8">
            <button id="generateBtn" onclick="generateImages()" class="neumorphic-btn px-12 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 transition-all text-lg font-medium">
                <span id="generateText">生成朋友圈图片</span>
                <span id="generateLoading" class="loading hidden ml-2"></span>
            </button>
        </div>

        <!-- 配置面板 -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">朋友圈配置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 基础信息 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布者姓名</label>
                    <input type="text" id="publisherName" value="飞书-Ben" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布时间</label>
                    <input type="text" id="publishTime" value="昨天" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">头像文件名</label>
                    <input type="text" id="avatarFile" value="1.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                
                <!-- 内容配置 -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">发布内容</label>
                    <textarea id="content" rows="4" class="neumorphic-input w-full px-4 py-2 rounded-xl">小小的milestone, Google给我开Adsense账号了,以后给Google打工。</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">配图文件名（逗号分隔，最多9张）</label>
                    <input type="text" id="contentImages" value="1.png,2.png" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="1.png,2.png,3.png">
                </div>
                
                <!-- 顶部图片配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">顶部图片文件名</label>
                    <input type="text" id="topImageFile" value="" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="顶部图片文件名（可选）">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间字体大小</label>
                    <input type="number" id="timeFontSize" value="16" min="12" max="24" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间左边距比例</label>
                    <input type="number" id="timeLeftRatio" value="0.1" min="0" max="1" step="0.1" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">时间右边距比例</label>
                    <input type="number" id="timeRightRatio" value="0.1" min="0" max="1" step="0.1" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                
                <!-- 点赞配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞数量</label>
                    <input type="number" id="likeCount" value="2" min="0" max="50" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">点赞者头像文件名（逗号分隔）</label>
                    <input type="text" id="likers" value="1.jpg,2.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                
                <!-- 评论配置 -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">评论（JSON格式）</label>
                    <textarea id="comments" rows="3" class="neumorphic-input w-full px-4 py-2 rounded-xl">[{"name":"飞书-Ben","content":"真aha moment, 我就需要这样的agent"},{"name":"用户","content":"很棒的分享！"}]</textarea>
                </div>
                
                <!-- 尺寸配置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片宽度</label>
                    <input type="number" id="imageWidth" value="375" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">图片高度</label>
                    <input type="number" id="imageHeight" value="812" class="neumorphic-input w-full px-4 py-2 rounded-xl">
                </div>
            </div>
        </div>

        <!-- 预览区域 -->
        <div id="previewSection" class="hidden">
            <div class="neumorphic-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6">预览结果</h3>
                <div id="previewContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 预览内容将在这里显示 -->
                </div>
            </div>
        </div>
    </main>

    <script>
        let uploadedFiles = [];
        let uploadedImages = [];
        let generatedImages = [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupImageUpload();
        });

        // 设置文件上传
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                uploadedFiles = files;
            });
        }

        // 设置图片上传
        function setupImageUpload() {
            const imageInput = document.getElementById('imageInput');
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                uploadedImages = uploadedImages.concat(files);
            });
        }

        // 生成图片
        async function generateImages() {
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoading = document.getElementById('generateLoading');
            
            generateBtn.disabled = true;
            generateText.textContent = '生成中...';
            generateLoading.classList.remove('hidden');

            try {
                generatedImages = [];
                
                if (uploadedFiles.length > 0) {
                    // 批量生成
                    for (let file of uploadedFiles) {
                        const images = await processExcelFile(file);
                        generatedImages.push({
                            fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                            images: images
                        });
                    }
                } else {
                    // 单次生成
                    const config = getConfigFromForm();
                    const image = await generatePyqImage(config);
                    generatedImages.push({
                        fileName: '朋友圈',
                        images: [image]
                    });
                }
                
                showPreview();
            } catch (error) {
                console.error('生成图片失败:', error);
                alert('生成图片失败: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateLoading.classList.add('hidden');
                generateText.textContent = '生成朋友圈图片';
            }
        }

        // 从表单获取配置
        function getConfigFromForm() {
            return {
                publisher_name: document.getElementById('publisherName').value || '飞书-Ben',
                publish_time: document.getElementById('publishTime').value || '昨天',
                avatar_file: document.getElementById('avatarFile').value || '1.jpg',
                content: document.getElementById('content').value || '',
                content_images: document.getElementById('contentImages').value.split(',').filter(name => name.trim()),
                top_image_file: document.getElementById('topImageFile').value || '',
                time_font_size: parseInt(document.getElementById('timeFontSize').value) || 16,
                time_left_ratio: parseFloat(document.getElementById('timeLeftRatio').value) || 0.1,
                time_right_ratio: parseFloat(document.getElementById('timeRightRatio').value) || 0.1,
                like_count: parseInt(document.getElementById('likeCount').value) || 0,
                likers: document.getElementById('likers').value.split(',').filter(name => name.trim()),
                comments: JSON.parse(document.getElementById('comments').value || '[]'),
                imageWidth: parseInt(document.getElementById('imageWidth').value) || 375,
                imageHeight: parseInt(document.getElementById('imageHeight').value) || 812
            };
        }

        // 处理Excel文件
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        const configs = parseExcelData(jsonData);
                        const images = [];
                        
                        for (let config of configs) {
                            const image = await generatePyqImage(config);
                            images.push(image);
                        }
                        
                        resolve(images);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function() {
                    reject(new Error('文件读取失败'));
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // 解析Excel数据
        function parseExcelData(jsonData) {
            if (jsonData.length < 2) {
                throw new Error('Excel文件格式不正确');
            }

            const headers = jsonData[0];
            const data = jsonData.slice(1);
            
            const indexCol = headers.findIndex(h => h === 'index');
            const contentCol = headers.findIndex(h => h === 'content');

            if (indexCol === -1 || contentCol === -1) {
                throw new Error('Excel文件缺少必要的列：index, content');
            }

            const configs = [];
            let currentConfig = {};

            for (let row of data) {
                const index = row[indexCol];
                const content = row[contentCol];

                if (index !== undefined && index !== null && index !== '') {
                    if (['publisher_name', 'publish_time', 'avatar_file', 'content', 'content_images', 'top_image_file', 'time_font_size', 'time_left_ratio', 'time_right_ratio', 'like_count', 'likers', 'comments', 'imageWidth', 'imageHeight'].includes(index)) {
                        if (index === 'comments') {
                            try {
                                currentConfig[index] = content ? JSON.parse(content) : [];
                            } catch (error) {
                                currentConfig[index] = [];
                            }
                        } else if (index === 'likers' || index === 'content_images') {
                            try {
                                currentConfig[index] = content ? JSON.parse(content) : [];
                            } catch (error) {
                                currentConfig[index] = content ? content.split(',').filter(name => name.trim()) : [];
                            }
                        } else if (index === 'like_count' || index === 'imageWidth' || index === 'imageHeight' || index === 'time_font_size') {
                            currentConfig[index] = content ? (parseInt(content) || 0) : 0;
                        } else if (index === 'time_left_ratio' || index === 'time_right_ratio') {
                            currentConfig[index] = content ? (parseFloat(content) || 0.1) : 0.1;
                        } else {
                            currentConfig[index] = content || '';
                        }
                    } else if (index === 'end') {
                        configs.push({...currentConfig});
                        currentConfig = {};
                    }
                }
            }

            if (Object.keys(currentConfig).length > 0) {
                configs.push(currentConfig);
            }

            if (configs.length === 0) {
                throw new Error('Excel文件中没有找到有效的配置');
            }

            return configs;
        }

        // 生成朋友圈图片
        async function generatePyqImage(config) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = config.imageWidth || 375;
            canvas.height = config.imageHeight || 812;

            // 绘制背景
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let currentY = 0;

            // 绘制顶部图片（如果有）
            if (config.top_image_file) {
                try {
                    const topImage = await loadImage(config.top_image_file);
                    const topImageWidth = canvas.width;
                    const topImageHeight = (topImage.height / topImage.width) * topImageWidth;
                    
                    ctx.drawImage(topImage, 0, 0, topImageWidth, topImageHeight);
                    
                    // 在顶部图片上绘制时间
                    const timeText = new Date().toLocaleTimeString('zh-CN', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `bold ${config.time_font_size || 16}px "SF Pro Display", "Helvetica Neue", Arial, sans-serif`;
                    ctx.textAlign = 'center';
                    
                    const timeX = canvas.width * (config.time_left_ratio || 0.1) + (canvas.width * (1 - config.time_left_ratio - config.time_right_ratio)) / 2;
                    const timeY = topImageHeight * 0.15;
                    
                    // 添加文字阴影
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 2;
                    ctx.fillText(timeText, timeX, timeY);
                    ctx.shadowBlur = 0;
                    
                    currentY = topImageHeight;
                } catch (error) {
                    console.log('顶部图片加载失败，跳过');
                }
            }

            // 绘制朋友圈内容
            await drawPyqContent(ctx, config, canvas.width, canvas.height, currentY);

            const imageData = canvas.toDataURL('image/png');
            return {
                dataUrl: imageData,
                width: canvas.width,
                height: canvas.height
            };
        }

        // 绘制朋友圈内容
        async function drawPyqContent(ctx, config, width, height, startY) {
            let currentY = startY + 20; // 顶部间距
            
            // 绘制发布者头像
            const avatarSize = 40;
            const avatarX = 15;
            const avatarY = currentY;
            
            let avatarImage = null;
            try {
                if (config.avatar_file) {
                    avatarImage = await loadImage(config.avatar_file);
                }
            } catch (error) {
                console.log('头像加载失败，使用默认头像');
            }
            
            if (avatarImage) {
                ctx.drawImage(avatarImage, avatarX, avatarY, avatarSize, avatarSize);
            } else {
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(avatarX, avatarY, avatarSize, avatarSize);
            }
            
            // 绘制发布者姓名
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(config.publisher_name || '飞书-Ben', avatarX + avatarSize + 10, avatarY + 16);
            
            currentY += avatarSize + 10;
            
            // 绘制内容文本
            if (config.content) {
                const textX = avatarX + avatarSize + 10;
                const textWidth = width - textX - 15;
                const lineHeight = 20;
                
                ctx.fillStyle = '#000000';
                ctx.font = '16px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                
                const words = config.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let word of words) {
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > textWidth) {
                        if (currentLine === '') {
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                for (let line of lines) {
                    ctx.fillText(line, textX, currentY);
                    currentY += lineHeight;
                }
                
                currentY += 10;
            }
            
            // 绘制多张配图
            if (config.content_images && config.content_images.length > 0) {
                const maxImages = Math.min(config.content_images.length, 9);
                const imageSize = (width - 30 - 20) / 3; // 减去左右边距和图片间距
                const imagesPerRow = 3;
                
                for (let i = 0; i < maxImages; i++) {
                    const row = Math.floor(i / imagesPerRow);
                    const col = i % imagesPerRow;
                    const imageX = 15 + col * (imageSize + 5);
                    const imageY = currentY + row * (imageSize + 5);
                    
                    try {
                        const contentImage = await loadImage(config.content_images[i]);
                        
                        // 计算裁剪区域，保持正方形
                        const minDimension = Math.min(contentImage.width, contentImage.height);
                        const sourceX = (contentImage.width - minDimension) / 2;
                        const sourceY = (contentImage.height - minDimension) / 2;
                        
                        ctx.drawImage(
                            contentImage,
                            sourceX, sourceY, minDimension, minDimension,
                            imageX, imageY, imageSize, imageSize
                        );
                    } catch (error) {
                        // 绘制图片占位符
                        ctx.fillStyle = '#e0e0e0';
                        ctx.fillRect(imageX, imageY, imageSize, imageSize);
                    }
                }
                
                const rows = Math.ceil(maxImages / imagesPerRow);
                currentY += rows * (imageSize + 5) + 10;
            }
            
            // 绘制时间
            if (config.publish_time) {
                ctx.fillStyle = '#8e8e93';
                ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(config.publish_time, 15, currentY + 14);
                currentY += 25;
            }
            
            // 绘制点赞区域
            if (config.like_count && config.like_count > 0) {
                currentY = await drawLikes(ctx, config, width, currentY);
            }
            
            // 绘制评论区域
            if (config.comments && config.comments.length > 0) {
                currentY = drawComments(ctx, config, width, currentY);
            }
        }

        // 绘制点赞区域
        async function drawLikes(ctx, config, width, startY) {
            const likeIconSize = 16;
            const likeIconX = 15;
            const likeIconY = startY + 12;
            
            // 绘制本地点赞图标（使用emoji作为替代）
            ctx.fillStyle = '#ff3b30';
            ctx.font = `${likeIconSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText('❤️', likeIconX, likeIconY);
            
            // 绘制点赞者头像
            const avatarSize = 20;
            const maxAvatarsPerRow = 8;
            const avatarSpacing = 5;
            let currentX = likeIconX + likeIconSize + 10;
            let currentY = startY;
            let avatarCount = 0;
            
            for (let i = 0; i < Math.min(config.like_count, config.likers ? config.likers.length : 0); i++) {
                if (avatarCount >= maxAvatarsPerRow) {
                    currentX = likeIconX + likeIconSize + 10;
                    currentY += avatarSize + avatarSpacing;
                    avatarCount = 0;
                }
                
                let likerAvatar = null;
                try {
                    if (config.likers && config.likers[i]) {
                        likerAvatar = await loadImage(config.likers[i]);
                    }
                } catch (error) {
                    console.log('点赞者头像加载失败，使用默认头像');
                }
                
                if (likerAvatar) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(currentX + avatarSize/2, currentY + avatarSize/2, avatarSize/2, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.drawImage(likerAvatar, currentX, currentY, avatarSize, avatarSize);
                    ctx.restore();
                } else {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(currentX + avatarSize/2, currentY + avatarSize/2, avatarSize/2, 0, 2 * Math.PI);
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fill();
                    ctx.restore();
                }
                
                currentX += avatarSize + avatarSpacing;
                avatarCount++;
            }
            
            return currentY + avatarSize + 15;
        }

        // 绘制评论区域
        function drawComments(ctx, config, width, startY) {
            let currentY = startY + 5;
            
            if (!Array.isArray(config.comments)) {
                return currentY;
            }
            
            // 绘制评论区灰色背景
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(15, currentY - 5, width - 30, 100); // 临时高度，后面会调整
            
            for (let comment of config.comments) {
                if (!comment || typeof comment !== 'object' || !comment.content) {
                    continue;
                }
                
                // 绘制评论者姓名（加上冒号）
                ctx.fillStyle = '#007AFF';
                ctx.font = 'bold 14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText((comment.name || '用户') + '：', 15, currentY + 14);
                
                const nameWidth = ctx.measureText((comment.name || '用户') + '：').width;
                const commentX = 15 + nameWidth + 8;
                const commentWidth = width - commentX - 15;
                const lineHeight = 18;
                
                ctx.fillStyle = '#000000';
                ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                
                const words = comment.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let word of words) {
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > commentWidth) {
                        if (currentLine === '') {
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (i === 0) {
                        ctx.fillText(line, commentX, currentY + 14);
                    } else {
                        ctx.fillText(line, 15, currentY + 14);
                    }
                    currentY += lineHeight;
                }
                
                currentY += 8;
            }
            
            // 调整评论区背景高度
            const commentAreaHeight = currentY - startY + 10;
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(15, startY - 5, width - 30, commentAreaHeight);
            
            // 重新绘制评论内容（因为背景覆盖了）
            currentY = startY + 5;
            for (let comment of config.comments) {
                if (!comment || typeof comment !== 'object' || !comment.content) {
                    continue;
                }
                
                ctx.fillStyle = '#007AFF';
                ctx.font = 'bold 14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText((comment.name || '用户') + '：', 15, currentY + 14);
                
                const nameWidth = ctx.measureText((comment.name || '用户') + '：').width;
                const commentX = 15 + nameWidth + 8;
                const commentWidth = width - commentX - 15;
                const lineHeight = 18;
                
                ctx.fillStyle = '#000000';
                ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                
                const words = comment.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let word of words) {
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > commentWidth) {
                        if (currentLine === '') {
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (i === 0) {
                        ctx.fillText(line, commentX, currentY + 14);
                    } else {
                        ctx.fillText(line, 15, currentY + 14);
                    }
                    currentY += lineHeight;
                }
                
                currentY += 8;
            }
            
            return currentY + 10;
        }

        // 显示预览
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContainer = document.getElementById('previewContainer');
            
            previewContainer.innerHTML = '';

            generatedImages.forEach((fileData, fileIndex) => {
                fileData.images.forEach((image, imageIndex) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'neumorphic-card rounded-xl p-4';
                    imageDiv.innerHTML = `
                        <img src="${image.dataUrl}" alt="朋友圈图片" class="w-full h-auto rounded-lg mb-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">${image.width} × ${image.height}</span>
                            <button onclick="downloadImage('${image.dataUrl}', '${fileData.fileName}_${imageIndex + 1}.png')" 
                                    class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                下载
                            </button>
                        </div>
                    `;
                    previewContainer.appendChild(imageDiv);
                });
            });

            previewSection.classList.remove('hidden');
        }

        // 下载图片
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 加载图片
        function loadImage(imageName) {
            return new Promise((resolve, reject) => {
                // 优先从上传的图片中查找
                let imageFile = null;
                if (uploadedImages.length > 0) {
                    imageFile = uploadedImages.find(img => 
                        img.name.toLowerCase() === imageName.toLowerCase() ||
                        img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                        imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                    );
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`图片加载失败: ${imageName}`));
                
                if (imageFile) {
                    img.src = URL.createObjectURL(imageFile);
                } else {
                    img.src = `../res/pyq/${imageName}`;
                }
            });
        }
    </script>
</body>
</html> 