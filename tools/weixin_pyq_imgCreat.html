<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‹å‹åœˆå›¾ç‰‡ç”Ÿæˆå™¨ - å›è¨€å·¥å…·ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'neumorphic': {
                            'light': '#f0f0f3',
                            'dark': '#d1d9e6',
                            'shadow': '#a3b1c6'
                        }
                    },
                    boxShadow: {
                        'neumorphic': '20px 20px 60px #bebebe, -20px -20px 60px #ffffff',
                        'neumorphic-inset': 'inset 20px 20px 60px #bebebe, inset -20px -20px 60px #ffffff',
                        'neumorphic-pressed': 'inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        /* æ‹Ÿç‰©é£èƒŒæ™¯æ¸å˜ */
        .neumorphic-bg {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
        }
        
        /* æ‹Ÿç‰©é£å¡ç‰‡ */
        .neumorphic-card {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .neumorphic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 25px 25px 75px #bebebe, -25px -25px 75px #ffffff;
        }
        
        /* æ‹Ÿç‰©é£æŒ‰é’® */
        .neumorphic-btn {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
            transition: all 0.2s ease;
        }
        
        .neumorphic-btn:hover {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(2px);
        }
        
        .neumorphic-btn:active {
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            transform: translateY(4px);
        }
        
        /* æ‹Ÿç‰©é£è¾“å…¥æ¡† */
        .neumorphic-input {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            box-shadow: inset 6px 6px 12px #bebebe, inset -6px -6px 12px #ffffff;
            border: none;
            transition: all 0.3s ease;
        }
        
        .neumorphic-input:focus {
            box-shadow: inset 8px 8px 16px #bebebe, inset -8px -8px 16px #ffffff;
            outline: none;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #d1d9e6, #a3b1c6);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #a3b1c6, #8a9bb3);
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #d1d9e6;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.05);
        }
        
        .upload-area.dragover {
            border-color: #7d93f3;
            background: rgba(125, 147, 243, 0.1);
        }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7d93f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="neumorphic-bg min-h-screen">
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-purple-800 bg-clip-text text-transparent mb-4">
                æœ‹å‹åœˆå›¾ç‰‡ç”Ÿæˆå™¨
            </h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
                ç”Ÿæˆé€¼çœŸçš„æœ‹å‹åœˆå›¾ç‰‡ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€ç‚¹èµã€è¯„è®ºç­‰åŠŸèƒ½ã€‚å¯è‡ªå®šä¹‰é…ç½®æˆ–ä¸Šä¼ Excelæ‰¹é‡ç”Ÿæˆã€‚
            </p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
                <!-- Excelæ–‡ä»¶ä¸Šä¼  -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆæ‰¹é‡ç”Ÿæˆï¼‰</h3>
                        <a href="/res/pyq/pyq_example.xlsx" download class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors whitespace-nowrap">
                            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            ä¸‹è½½ç¤ºä¾‹Excelæ–‡ä»¶
                        </a>
                    </div>
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="uploadArea">
                            <div class="mb-2">
                                <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                            </div>
                            <p class="text-sm font-medium text-gray-700 mb-1">æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                            <p class="text-xs text-gray-500 mb-2">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" multiple class="hidden">
                            <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                                é€‰æ‹©æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡æ–‡ä»¶ä¸Šä¼  -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼ˆå¤´åƒã€é…å›¾ï¼‰</h3>
                    <div class="upload-area rounded-xl p-4 text-center flex-1 h-full" id="imageUploadArea">
                        <div class="mb-2">
                            <svg class="w-8 h-8 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm font-medium text-gray-700 mb-1">æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</p>
                        <p class="text-xs text-gray-500 mb-2">æ”¯æŒjpgã€pngç­‰æ ¼å¼ï¼Œç”¨äºå¤´åƒå’Œé…å›¾</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all">
                            é€‰æ‹©å›¾ç‰‡
                        </button>
                    </div>
                    <div id="imagePreview" class="mt-2 grid grid-cols-3 gap-1 hidden">
                        <!-- å›¾ç‰‡é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <div class="text-center mb-8">
            <button id="generateBtn" onclick="generateImages()" class="neumorphic-btn px-12 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 transition-all text-lg font-medium">
                <span id="generateText">ç”Ÿæˆæœ‹å‹åœˆå›¾ç‰‡</span>
                <span id="generateLoading" class="loading hidden ml-2"></span>
            </button>
            <button id="previewBtn" onclick="previewSingle()" class="neumorphic-btn px-8 py-4 rounded-2xl bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 transition-all text-lg font-medium ml-4">
                é¢„è§ˆæ•ˆæœ
            </button>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="errorSection" class="hidden mb-8">
            <div class="neumorphic-card rounded-3xl p-8 border-l-4 border-red-500">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-red-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">å¤„ç†å¤±è´¥</h3>
                        <p id="errorMessage" class="text-gray-600 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="previewSection" class="hidden">
            <div class="neumorphic-card rounded-3xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-6">é¢„è§ˆç»“æœ</h3>
                <div id="previewContainer" class="preview-container custom-scrollbar">
                    <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="downloadAll()" class="neumorphic-btn px-8 py-3 rounded-2xl bg-gradient-to-r from-green-600 to-green-700 text-white hover:from-green-700 hover:to-green-800 transition-all">
                        ä¸‹è½½å…¨éƒ¨
                    </button>
                    <button onclick="clearAll()" class="neumorphic-btn px-8 py-3 rounded-2xl text-gray-700 hover:text-red-600 transition-all">
                        æ¸…ç©º
                    </button>
                </div>
            </div>
        </div>

        <!-- é…ç½®é¢æ¿ -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">æœ‹å‹åœˆé…ç½®</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å‘å¸ƒè€…å§“å</label>
                    <input type="text" id="publisherName" value="é£ä¹¦-Ben" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="å‘å¸ƒè€…å§“å">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å‘å¸ƒæ—¶é—´</label>
                    <input type="text" id="publishTime" value="æ˜¨å¤©" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="å‘å¸ƒæ—¶é—´">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¤´åƒæ–‡ä»¶å</label>
                    <input type="text" id="avatarFile" value="1.jpg" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="å¤´åƒæ–‡ä»¶å">
                </div>
                
                <!-- å†…å®¹é…ç½® -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å‘å¸ƒå†…å®¹</label>
                    <textarea id="content" rows="4" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="è¾“å…¥æœ‹å‹åœˆå†…å®¹...">å°å°çš„milestone, Googleç»™æˆ‘å¼€Adsenseè´¦å·äº†,ä»¥åç»™Googleæ‰“å·¥ã€‚è¿™ä¸ªä¸­é—´è¿˜æœ‰ä¸ªå°æ•…äº‹,ä¹Ÿå¾ˆå¥½ç©,åˆ†äº«ä¸€ä¸‹ã€‚æˆ‘æœ‰ä¸ªæœ‰ç‚¹æµé‡çš„ç½‘ç«™,æƒ³æŒ‚</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é…å›¾æ–‡ä»¶å</label>
                    <input type="text" id="contentImage" value="" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="é…å›¾æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰">
                </div>
                
                <!-- ç‚¹èµé…ç½® -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç‚¹èµæ•°é‡</label>
                    <input type="number" id="likeCount" value="2" min="0" max="50" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="ç‚¹èµæ•°é‡">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç‚¹èµè€…å§“åï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="likers" value="å¼ ä¸‰,æå››" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="ç‚¹èµè€…å§“åï¼Œé€—å·åˆ†éš”">
                </div>
                
                <!-- è¯„è®ºé…ç½® -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¯„è®ºï¼ˆJSONæ ¼å¼ï¼‰</label>
                    <textarea id="comments" rows="3" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder='[{"name":"é£ä¹¦-Ben","content":"çœŸaha moment, æˆ‘å°±éœ€è¦è¿™æ ·çš„agent"},{"name":"é£ä¹¦-Ben","content":"æœ‰äººé—®èµ·æ¥,é¡ºä¾¿æ’æ’­ä¸€ä¸ªå°å¹¿å‘Š,éœ€è¦ä¹° Claude code çš„è¯,æ˜¨å¤©å†™äº†æ‰‹æŠŠæ‰‹æ•™ç¨‹,æ— éœ€æ¢¯å­,æ”¯æŒå¾®ä¿¡æ”¯ä»˜: https://larkcommunity.feishu.c..."}]'>[{"name":"é£ä¹¦-Ben","content":"çœŸaha moment, æˆ‘å°±éœ€è¦è¿™æ ·çš„agent"},{"name":"é£ä¹¦-Ben","content":"æœ‰äººé—®èµ·æ¥,é¡ºä¾¿æ’æ’­ä¸€ä¸ªå°å¹¿å‘Š,éœ€è¦ä¹° Claude code çš„è¯,æ˜¨å¤©å†™äº†æ‰‹æŠŠæ‰‹æ•™ç¨‹,æ— éœ€æ¢¯å­,æ”¯æŒå¾®ä¿¡æ”¯ä»˜: https://larkcommunity.feishu.c..."}]</textarea>
                </div>
                
                <!-- å°ºå¯¸é…ç½® -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å›¾ç‰‡å®½åº¦</label>
                    <input type="number" id="imageWidth" value="375" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="375">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å›¾ç‰‡é«˜åº¦</label>
                    <input type="number" id="imageHeight" value="812" class="neumorphic-input w-full px-4 py-2 rounded-xl" placeholder="812">
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="neumorphic-card rounded-3xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6">ä½¿ç”¨è¯´æ˜</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">Excelæ–‡ä»¶æ ¼å¼è¦æ±‚ï¼š</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>â€¢ ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œï¼Œå¿…é¡»åŒ…å«ï¼šindex, type, content</li>
                        <li>â€¢ ç¬¬2-8è¡Œä¸ºé…ç½®è¡Œï¼Œç”¨äºè®¾ç½®æœ‹å‹åœˆå‚æ•°</li>
                        <li>â€¢ ç¬¬9è¡Œå¼€å§‹ä¸ºæœ‹å‹åœˆè®°å½•</li>
                        <li>â€¢ é…ç½®é¡¹åŒ…æ‹¬ï¼špublisher_name, publish_time, avatar_file, content, content_image, like_count, likers, comments</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-3">åŠŸèƒ½è¯´æ˜ï¼š</h4>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>â€¢ <strong>å¤´åƒ</strong>ï¼šä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå¦åˆ™ä»res/pyqæ–‡ä»¶å¤¹éšæœºé€‰æ‹©</li>
                        <li>â€¢ <strong>é…å›¾</strong>ï¼šæ”¯æŒå•å¼ å›¾ç‰‡ï¼Œä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡</li>
                        <li>â€¢ <strong>ç‚¹èµ</strong>ï¼šæ˜¾ç¤ºç‚¹èµè€…å¤´åƒï¼Œæ¯è¡Œæœ€å¤š8ä¸ª</li>
                        <li>â€¢ <strong>è¯„è®º</strong>ï¼šæ”¯æŒå¤šæ¡è¯„è®ºï¼ŒåŒ…å«è¯„è®ºè€…å§“åå’Œå†…å®¹</li>
                        <li>â€¢ <strong>æ ·å¼</strong>ï¼šå®Œå…¨è¿˜åŸå¾®ä¿¡æœ‹å‹åœˆçš„çœŸå®æ ·å¼</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        // å…¨å±€å˜é‡
        let uploadedFiles = [];
        let uploadedImages = [];
        let generatedImages = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupImageUpload();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });

            // ç‚¹å‡»ä¸Šä¼ 
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFiles(files);
            });
        }

        // è®¾ç½®å›¾ç‰‡ä¸Šä¼ 
        function setupImageUpload() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');

            // æ‹–æ‹½ä¸Šä¼ 
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                imageUploadArea.classList.add('dragover');
            });

            imageUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
            });

            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                imageUploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // ç‚¹å‡»ä¸Šä¼ 
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleImageFiles(files);
            });
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFiles(files) {
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (excelFiles.length === 0) {
                showError('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰');
                return;
            }

            uploadedFiles = excelFiles;
            hideError();
            updateUploadStatus();
        }

        // å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶
        function handleImageFiles(files) {
            const imageFiles = files.filter(file => 
                file.type.startsWith('image/')
            );

            if (imageFiles.length === 0) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            uploadedImages = uploadedImages.concat(imageFiles);
            hideError();
            updateImageUploadStatus();
        }

        // æ›´æ–°ä¸Šä¼ çŠ¶æ€
        function updateUploadStatus() {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadedFiles.length > 0) {
                uploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">å·²é€‰æ‹© ${uploadedFiles.length} ä¸ªæ–‡ä»¶</p>
                    <div class="space-y-1">
                        ${uploadedFiles.map(file => `<p class="text-xs text-gray-500">${file.name}</p>`).join('')}
                    </div>
                    <button onclick="document.getElementById('fileInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        é‡æ–°é€‰æ‹©
                    </button>
                `;
            }
        }

        // æ›´æ–°å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
        function updateImageUploadStatus() {
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            
            if (uploadedImages.length > 0) {
                imageUploadArea.innerHTML = `
                    <div class="mb-2">
                        <svg class="w-8 h-8 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <p class="text-sm font-medium text-gray-700 mb-1">å·²é€‰æ‹© ${uploadedImages.length} å¼ å›¾ç‰‡</p>
                    <button onclick="document.getElementById('imageInput').click()" class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-gray-700 hover:text-blue-600 transition-all mt-2">
                        æ·»åŠ æ›´å¤šå›¾ç‰‡
                    </button>
                `;
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                imagePreview.innerHTML = uploadedImages.map((file, index) => `
                    <div class="relative">
                        <img src="${URL.createObjectURL(file)}" alt="${file.name}" class="w-full h-16 object-cover rounded-lg">
                        <button onclick="removeImage(${index})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">
                            Ã—
                        </button>
                    </div>
                `).join('');
                imagePreview.classList.remove('hidden');
            }
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImageUploadStatus();
        }

        // ç”Ÿæˆå›¾ç‰‡
        async function generateImages() {
            hideError();
            
            const generateBtn = document.getElementById('generateBtn');
            const generateText = document.getElementById('generateText');
            const generateLoading = document.getElementById('generateLoading');
            
            generateBtn.disabled = true;
            generateText.textContent = 'ç”Ÿæˆä¸­...';
            generateLoading.classList.remove('hidden');

            try {
                generatedImages = [];
                
                if (uploadedFiles.length > 0) {
                    // æ‰¹é‡ç”Ÿæˆ
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        generateText.textContent = `å¤„ç†æ–‡ä»¶ ${i + 1}/${uploadedFiles.length}...`;
                        
                        const images = await processExcelFile(file);
                        generatedImages.push({
                            fileName: file.name.replace(/\.(xlsx|xls)$/i, ''),
                            images: images
                        });
                    }
                } else {
                    // å•æ¬¡ç”Ÿæˆ
                    const config = getConfigFromForm();
                    const image = await generatePyqImage(config);
                    generatedImages.push({
                        fileName: 'æœ‹å‹åœˆ',
                        images: [image]
                    });
                }

                generateText.textContent = 'ç”Ÿæˆå®Œæˆï¼';
                setTimeout(() => {
                    generateText.textContent = 'ç”Ÿæˆæœ‹å‹åœˆå›¾ç‰‡';
                }, 1000);
                
                showPreview();
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                showError('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateLoading.classList.add('hidden');
            }
        }

        // ä»è¡¨å•è·å–é…ç½®
        function getConfigFromForm() {
            return {
                publisherName: document.getElementById('publisherName').value || 'é£ä¹¦-Ben',
                publishTime: document.getElementById('publishTime').value || 'æ˜¨å¤©',
                avatarFile: document.getElementById('avatarFile').value || '1.jpg',
                content: document.getElementById('content').value || '',
                contentImage: document.getElementById('contentImage').value || '',
                likeCount: parseInt(document.getElementById('likeCount').value) || 0,
                likers: document.getElementById('likers').value.split(',').filter(name => name.trim()),
                comments: JSON.parse(document.getElementById('comments').value || '[]'),
                imageWidth: parseInt(document.getElementById('imageWidth').value) || 375,
                imageHeight: parseInt(document.getElementById('imageHeight').value) || 812
            };
        }

        // å¤„ç†Excelæ–‡ä»¶
        async function processExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        // è§£æExcelæ•°æ®
                        const configs = parseExcelData(jsonData);
                        const images = [];
                        
                        for (let config of configs) {
                            const image = generatePyqImage(config);
                            images.push(image);
                        }
                        
                        resolve(images);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function() {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // è§£æExcelæ•°æ®
        function parseExcelData(jsonData) {
            if (jsonData.length < 2) {
                throw new Error('Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }

            const headers = jsonData[0];
            const data = jsonData.slice(1);
            
            // æŸ¥æ‰¾å¿…è¦çš„åˆ—
            const indexCol = headers.findIndex(h => h === 'index');
            const typeCol = headers.findIndex(h => h === 'type');
            const contentCol = headers.findIndex(h => h === 'content');

            if (indexCol === -1 || typeCol === -1 || contentCol === -1) {
                throw new Error('Excelæ–‡ä»¶ç¼ºå°‘å¿…è¦çš„åˆ—ï¼šindex, type, content');
            }

            // æå–é…ç½®
            const configs = [];
            let currentConfig = {};

            for (let row of data) {
                const index = row[indexCol];
                const type = row[typeCol];
                const content = row[contentCol];

                if (index && content !== undefined) {
                    if (['publisher_name', 'publish_time', 'avatar_file', 'content', 'content_image', 'like_count', 'likers', 'comments'].includes(index)) {
                        currentConfig[index] = content;
                    } else if (index === 'end') {
                        // ç»“æŸæ ‡è®°ï¼Œä¿å­˜å½“å‰é…ç½®
                        if (Object.keys(currentConfig).length > 0) {
                            configs.push({...currentConfig});
                            currentConfig = {};
                        }
                    }
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªé…ç½®
            if (Object.keys(currentConfig).length > 0) {
                configs.push(currentConfig);
            }

            if (configs.length === 0) {
                throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é…ç½®');
            }

            return configs;
        }

        // ç”Ÿæˆæœ‹å‹åœˆå›¾ç‰‡
        async function generatePyqImage(config) {
            // åˆ›å»ºCanvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = config.imageWidth || 375;
            canvas.height = config.imageHeight || 812;

            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶çŠ¶æ€æ 
            drawStatusBar(ctx, canvas.width);

            // ç»˜åˆ¶å¤´éƒ¨
            drawHeader(ctx, canvas.width);

            // ç»˜åˆ¶æœ‹å‹åœˆå†…å®¹
            await drawPyqContent(ctx, config, canvas.width, canvas.height);

            // è½¬æ¢ä¸ºå›¾ç‰‡
            const imageData = canvas.toDataURL('image/png');
            return {
                dataUrl: imageData,
                width: canvas.width,
                height: canvas.height
            };
        }

        // ç»˜åˆ¶çŠ¶æ€æ 
        function drawStatusBar(ctx, width) {
            const statusBarHeight = 44;
            
            // ç»˜åˆ¶æ—¶é—´
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('7:01', width / 2, 28);
            
            // ç»˜åˆ¶å³ä¾§çŠ¶æ€å›¾æ ‡
            const rightX = width - 20;
            ctx.fillStyle = '#000000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('100', rightX, 28);
        }

        // ç»˜åˆ¶å¤´éƒ¨
        function drawHeader(ctx, width) {
            const headerHeight = 44;
            const startY = 44;
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, startY, width, headerHeight);
            
            // ç»˜åˆ¶è¿”å›ç®­å¤´
            ctx.fillStyle = '#007AFF';
            ctx.font = '20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('â€¹', 15, startY + 28);
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 17px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('æœ‹å‹åœˆ', width / 2, startY + 28);
            
            // ç»˜åˆ¶ç›¸æœºå›¾æ ‡
            ctx.fillStyle = '#007AFF';
            ctx.font = '20px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('ğŸ“·', width - 15, startY + 28);
        }

        // ç»˜åˆ¶æœ‹å‹åœˆå†…å®¹
        async function drawPyqContent(ctx, config, width, height) {
            let currentY = 88; // çŠ¶æ€æ  + å¤´éƒ¨é«˜åº¦
            
            // ç»˜åˆ¶å‘å¸ƒè€…å¤´åƒ
            const avatarSize = 40;
            const avatarX = 15;
            const avatarY = currentY;
            
            // åŠ è½½å¤´åƒ
            let avatarImage = null;
            try {
                avatarImage = await loadAvatarImage(config.avatarFile);
            } catch (error) {
                console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
            }
            
            if (avatarImage) {
                ctx.drawImage(avatarImage, avatarX, avatarY, avatarSize, avatarSize);
            } else {
                // ç»˜åˆ¶é»˜è®¤å¤´åƒ
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(avatarX, avatarY, avatarSize, avatarSize);
            }
            
            // ç»˜åˆ¶å‘å¸ƒè€…å§“å
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(config.publisherName || 'é£ä¹¦-Ben', avatarX + avatarSize + 10, avatarY + 16);
            
            // ç»˜åˆ¶å‘å¸ƒæ—¶é—´
            ctx.fillStyle = '#8e8e93';
            ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
            ctx.fillText(config.publishTime || 'æ˜¨å¤©', avatarX + avatarSize + 10, avatarY + 32);
            
            currentY += avatarSize + 10;
            
            // ç»˜åˆ¶å†…å®¹æ–‡æœ¬
            if (config.content) {
                const textX = 15;
                const textWidth = width - 30;
                const lineHeight = 20;
                
                ctx.fillStyle = '#000000';
                ctx.font = '16px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                
                // æ”¹è¿›çš„æ–‡æœ¬æ¢è¡Œç®—æ³•
                const words = config.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > textWidth) {
                        if (currentLine === '') {
                            // å•ä¸ªå­—ç¬¦å°±è¶…å®½ï¼Œå¼ºåˆ¶æ¢è¡Œ
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                // ç»˜åˆ¶æ¯ä¸€è¡Œ
                for (let line of lines) {
                    ctx.fillText(line, textX, currentY);
                    currentY += lineHeight;
                }
                
                currentY += 10;
            }
            
            // ç»˜åˆ¶é…å›¾
            if (config.contentImage) {
                const imageX = 15;
                const imageY = currentY;
                const imageWidth = 200;
                const imageHeight = 150;
                
                // åŠ è½½é…å›¾
                let contentImage = null;
                try {
                    contentImage = await loadContentImage(config.contentImage);
                } catch (error) {
                    console.log('é…å›¾åŠ è½½å¤±è´¥');
                }
                
                if (contentImage) {
                    ctx.drawImage(contentImage, imageX, imageY, imageWidth, imageHeight);
                } else {
                    // ç»˜åˆ¶å›¾ç‰‡å ä½ç¬¦
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fillRect(imageX, imageY, imageWidth, imageHeight);
                }
                
                currentY += imageHeight + 10;
            }
            
            // ç»˜åˆ¶ç‚¹èµåŒºåŸŸ
            if (config.likeCount > 0) {
                currentY = drawLikes(ctx, config, width, currentY);
            }
            
            // ç»˜åˆ¶è¯„è®ºåŒºåŸŸ
            if (config.comments && config.comments.length > 0) {
                currentY = drawComments(ctx, config, width, currentY);
            }
        }

        // ç»˜åˆ¶ç‚¹èµåŒºåŸŸ
        function drawLikes(ctx, config, width, startY) {
            const likeIconSize = 16;
            const likeIconX = 15;
            const likeIconY = startY + 12; // è°ƒæ•´å¿ƒå½¢å›¾æ ‡å‚ç›´ä½ç½®
            
            // ç»˜åˆ¶å¿ƒå½¢å›¾æ ‡
            ctx.fillStyle = '#ff3b30';
            ctx.font = `${likeIconSize}px Arial`;
            ctx.textAlign = 'left';
            ctx.fillText('â¤ï¸', likeIconX, likeIconY);
            
            // ç»˜åˆ¶ç‚¹èµè€…å¤´åƒ
            const avatarSize = 20;
            const maxAvatarsPerRow = 8;
            const avatarSpacing = 5;
            let currentX = likeIconX + likeIconSize + 10;
            let currentY = startY;
            let avatarCount = 0;
            
            for (let i = 0; i < Math.min(config.likeCount, config.likers.length); i++) {
                if (avatarCount >= maxAvatarsPerRow) {
                    currentX = likeIconX + likeIconSize + 10;
                    currentY += avatarSize + avatarSpacing;
                    avatarCount = 0;
                }
                
                // ç»˜åˆ¶ç‚¹èµè€…å¤´åƒï¼ˆç®€åŒ–ç‰ˆï¼‰
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(currentX, currentY, avatarSize, avatarSize);
                
                // ç»˜åˆ¶ç‚¹èµè€…å§“å
                ctx.fillStyle = '#007AFF';
                ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(config.likers[i] || `ç”¨æˆ·${i+1}`, currentX + avatarSize + 5, currentY + 14);
                
                currentX += avatarSize + 50; // ä¸ºæ–‡å­—ç•™å‡ºç©ºé—´
                avatarCount++;
            }
            
            return currentY + avatarSize + 15; // å¢åŠ åº•éƒ¨é—´è·ï¼Œé¿å…ä¸è¯„è®ºé‡å 
        }

        // ç»˜åˆ¶è¯„è®ºåŒºåŸŸ
        function drawComments(ctx, config, width, startY) {
            let currentY = startY + 5; // å¢åŠ é¡¶éƒ¨é—´è·ï¼Œé¿å…ä¸ç‚¹èµåŒºåŸŸé‡å 
            
            for (let comment of config.comments) {
                // ç»˜åˆ¶è¯„è®ºè€…å§“å
                ctx.fillStyle = '#007AFF';
                ctx.font = 'bold 14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(comment.name || 'ç”¨æˆ·', 15, currentY + 14);
                
                // ç»˜åˆ¶è¯„è®ºå†…å®¹
                const commentX = 15;
                const commentWidth = width - 30;
                const lineHeight = 20; // å¢åŠ è¡Œé—´è·ï¼Œé¿å…æ–‡å­—é‡å 
                
                ctx.fillStyle = '#000000';
                ctx.font = '14px "SF Pro Display", "Helvetica Neue", Arial, sans-serif';
                
                // æ”¹è¿›çš„æ–‡æœ¬æ¢è¡Œç®—æ³•
                const words = comment.content.split('');
                const lines = [];
                let currentLine = '';
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > commentWidth) {
                        if (currentLine === '') {
                            // å•ä¸ªå­—ç¬¦å°±è¶…å®½ï¼Œå¼ºåˆ¶æ¢è¡Œ
                            lines.push(word);
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    } else {
                        currentLine = testLine;
                    }
                }
                
                if (currentLine) {
                    lines.push(currentLine);
                }
                
                // ç»˜åˆ¶æ¯ä¸€è¡Œ
                for (let line of lines) {
                    ctx.fillText(line, commentX, currentY + 14);
                    currentY += lineHeight;
                }
                
                currentY += 5;
            }
            
            return currentY + 10;
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewContainer = document.getElementById('previewContainer');
            
            previewContainer.innerHTML = '';

            generatedImages.forEach((fileData, fileIndex) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'mb-8 p-6 neumorphic-card rounded-2xl';
                fileDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-900 mb-4">${fileData.fileName}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${fileData.images.map((image, imageIndex) => `
                            <div class="neumorphic-card rounded-xl p-4">
                                <img src="${image.dataUrl}" alt="æœ‹å‹åœˆå›¾ç‰‡" class="w-full h-auto rounded-lg mb-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">${image.width} Ã— ${image.height}</span>
                                    <button onclick="downloadImage('${image.dataUrl}', '${fileData.fileName}_${imageIndex + 1}.png')" 
                                            class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                        ä¸‹è½½
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                previewContainer.appendChild(fileDiv);
            });

            previewSection.classList.remove('hidden');
        }

        // ä¸‹è½½å•ä¸ªå›¾ç‰‡
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ä¸‹è½½å…¨éƒ¨å›¾ç‰‡
        function downloadAll() {
            generatedImages.forEach((fileData, fileIndex) => {
                fileData.images.forEach((image, imageIndex) => {
                    setTimeout(() => {
                        downloadImage(image.dataUrl, `${fileData.fileName}_${imageIndex + 1}.png`);
                    }, fileIndex * 100 + imageIndex * 50);
                });
            });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
            
            // è‡ªåŠ¨éšè—é”™è¯¯æç¤º
            setTimeout(() => {
                errorSection.classList.add('hidden');
            }, 5000);
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }

        // ä»æ–‡ä»¶åŠ è½½å›¾ç‰‡
        function loadImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                img.src = URL.createObjectURL(file);
            });
        }

        // ä»æœåŠ¡å™¨åŠ è½½å›¾ç‰‡
        function loadImageFromServer(imageName, type = 'pyq') {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${imageName}`));
                img.src = `../res/${type}/${imageName}`;
            });
        }

        // åŠ è½½å¤´åƒå›¾ç‰‡
        async function loadAvatarImage(imageName) {
            // ä¼˜å…ˆä»ä¸Šä¼ çš„å›¾ç‰‡ä¸­æŸ¥æ‰¾
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }
            
            if (imageFile) {
                return await loadImageFromFile(imageFile);
            } else {
                // ä»æœåŠ¡å™¨åŠ è½½ï¼Œå¦‚æœå¤±è´¥åˆ™éšæœºé€‰æ‹©
                try {
                    return await loadImageFromServer(imageName, 'pyq');
                } catch (error) {
                    // éšæœºé€‰æ‹©å¤´åƒ
                    const randomIndex = Math.floor(Math.random() * 2) + 1;
                    return await loadImageFromServer(`${randomIndex}.jpg`, 'pyq');
                }
            }
        }

        // åŠ è½½é…å›¾
        async function loadContentImage(imageName) {
            // ä¼˜å…ˆä»ä¸Šä¼ çš„å›¾ç‰‡ä¸­æŸ¥æ‰¾
            let imageFile = null;
            if (uploadedImages.length > 0) {
                imageFile = uploadedImages.find(img => 
                    img.name.toLowerCase() === imageName.toLowerCase() ||
                    img.name.toLowerCase().includes(imageName.toLowerCase()) ||
                    imageName.toLowerCase().includes(img.name.toLowerCase().replace(/\.[^/.]+$/, ''))
                );
            }
            
            if (imageFile) {
                return await loadImageFromFile(imageFile);
            } else {
                // ä»æœåŠ¡å™¨åŠ è½½
                return await loadImageFromServer(imageName, 'pyq');
            }
        }

        // é¢„è§ˆå•ä¸ªæ•ˆæœ
        async function previewSingle() {
            hideError();
            
            const previewBtn = document.getElementById('previewBtn');
            previewBtn.disabled = true;
            previewBtn.textContent = 'é¢„è§ˆä¸­...';

            try {
                const config = getConfigFromForm();
                const image = await generatePyqImage(config);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewSection = document.getElementById('previewSection');
                const previewContainer = document.getElementById('previewContainer');
                
                previewContainer.innerHTML = `
                    <div class="mb-8 p-6 neumorphic-card rounded-2xl">
                        <h4 class="text-lg font-bold text-gray-900 mb-4">é¢„è§ˆæ•ˆæœ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="neumorphic-card rounded-xl p-4">
                                <img src="${image.dataUrl}" alt="æœ‹å‹åœˆé¢„è§ˆ" class="w-full h-auto rounded-lg mb-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">${image.width} Ã— ${image.height}</span>
                                    <button onclick="downloadImage('${image.dataUrl}', 'æœ‹å‹åœˆé¢„è§ˆ.png')" 
                                            class="neumorphic-btn px-4 py-2 rounded-lg text-sm text-blue-600 hover:text-blue-700 transition-colors">
                                        ä¸‹è½½
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                previewSection.classList.remove('hidden');
            } catch (error) {
                console.error('é¢„è§ˆå¤±è´¥:', error);
                showError('é¢„è§ˆå¤±è´¥: ' + error.message);
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = 'é¢„è§ˆæ•ˆæœ';
            }
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            uploadedFiles = [];
            uploadedImages = [];
            generatedImages = [];
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            hideError();
            updateUploadStatus();
            updateImageUploadStatus();
        }
    </script>
</body>
</html>